<!DOCTYPE html> 
<html lang="en-us"><head><script>const t=localStorage.getItem('bulma-theme'); if (t !== null) { document.documentElement.setAttribute('data-theme', t);} </script><meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="msapplication-TileImage" content="/ms-icon-144x144.png"><meta name="msapplication-TileColor" content="#2f2949">
  <meta name="theme-color" content="#2f2949"><title>Recommendation system in the very, very wrong and ugly (but somehow funny) way | DevJoyOps</title>
  <meta property="og:title" content="Recommendation system in the very, very wrong and ugly (but somehow funny) way - DevJoyOps">
  <meta property="og:type" content="article">
  
  <meta property="article:published_time" content="2024-05-27T18:41:55&#43;08:00">
  
  
  <meta property="article:modified_time" content="2024-05-27T18:41:55&#43;08:00">
  
  <meta name="keywords" content="">
  <meta name="description" content="Recommendation system in the very, very wrong and ugly (but somehow funny) way">
  <link rel="icon" href="/favicon.ico" sizes="any">
  <link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
  <link rel="apple-touch-icon" href="/apple-icon-180x180.png">
    <link rel="stylesheet" type="text/css" href="/css/bulma.min.css">
    <link rel="stylesheet" type="text/css" href="/css/hulga.min.css">
</head>
<body>
  <div id="main"><section class="hero is-primary shadow-hero ">
  <div class="hero-head">
    <nav class="navbar is-primary" role="navigation" aria-label="dropdown navigation">
  <div class="container">
    <div class="navbar-brand"><a class="navbar-item " href="/">
        DevJoyOps
      </a>
      <a role="button" class="navbar-burger" data-target="navMenu" aria-label="menu" aria-expanded="false">
        <span aria-hidden="true"></span>
        <span aria-hidden="true"></span>
        <span aria-hidden="true"></span>
        <span aria-hidden="true"></span>
      </a>
    </div>
    <div class="navbar-menu" id="navMenu">
      <div class="navbar-end"><div class="navbar-item has-dropdown is-hoverable">
  <a class="navbar-link">
    <svg
    xmlns="http://www.w3.org/2000/svg"
    width="1em" height="1em"
    fill="currentColor"
    viewBox="0 0 32 32"
    >
    <path d="M16 .5C7.4.5.5 7.4.5 16S7.4 31.5 16 31.5 31.5 24.6 31.5 16 24.6.5 16 .5zm0 28.1V3.4C23 3.4 28.6 9 28.6 16S23 28.6 16 28.6z" />
  </svg>
  </a>
  <div class="navbar-dropdown" id="navDropdown">
    <a class="navbar-item theme-toggle" data-value="light">
      <span class="ticon">
      <svg viewBox="0 0 24 24"><path fill="none" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 12a4 4 0 1 0 8 0a4 4 0 1 0-8 0m-5 0h1m8-9v1m8 8h1m-9 8v1M5.6 5.6l.7.7m12.1-.7l-.7.7m0 11.4l.7.7m-12.1-.7l-.7.7"></path></svg>
      </span>Light</a>
    <a class="navbar-item theme-toggle" data-value="dark">
      <span class="ticon">
      <svg viewBox="0 0 24 24"><path fill="none" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 3h.393a7.5 7.5 0 0 0 7.92 12.446A9 9 0 1 1 12 2.992z"></path></svg>
      </span>Dark</a>
    <a class="navbar-item theme-toggle" data-value="system">
      <span class="ticon">
      <svg viewBox="0 0 24 24"><path fill="none" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 5a1 1 0 0 1 1-1h16a1 1 0 0 1 1 1v10a1 1 0 0 1-1 1H4a1 1 0 0 1-1-1zm4 15h10m-8-4v4m6-4v4"></path></svg>
      </span>System</a>
  </div>
</div>

        <a class="navbar-item" href="/" title="index">Home</a>
      
        <a class="navbar-item" href="/categories/" title="categories">Categories</a>
      
        <a class="navbar-item" href="/tags/" title="tags">Tags</a>
      
      </div>
    </div>
  </div>
</nav>

  </div>
  <div class="hero-body">
    <header class="container has-text-centered" data-pagefind-body>
      <h1 class="title post-title is-spaced">
        Recommendation system in the very, very wrong and ugly (but somehow funny) way
      </h1>
      <h2 class="subtitle"><time>2024/05/27</time> ãƒ»<span class="post-cat mr-2">
              <a href="/categories/data/">Data</a>
            </span></h2>
      
      <div>
        <span class="post-tag mr-2 post-cat">
          <a href="/tags/sql/">#SQL</a>
        </span>
        <span class="post-tag mr-2 post-cat">
          <a href="/tags/postgresql/">#PostgreSQL</a>
        </span>
        <span class="post-tag mr-2 post-cat">
          <a href="/tags/kaggle/">#Kaggle</a>
        </span>
      </div>
      
    </header>
  </div>
</section>
<section class="section">
  <div class="container">
    <div class="columns">
      
      <div class="column is-three-fifths is-offset-one-fifth">
      
        <article class="content" id="post-content" data-pagefind-body><h2 id="the-topic">The topic</h2>
<p>Studying how collaborative filtering recommendation systems work, I tried to do the typical movie recommendation system practice based on a Kaggle dataset. Specifically this:</p>
<blockquote>
<p><a href="https://www.kaggle.com/datasets/grouplens/movielens-20m-dataset">https://www.kaggle.com/datasets/grouplens/movielens-20m-dataset</a></p>
</blockquote>
<p>Once downloaded, the two interesting files to start exploring the topic are these two:</p>
<pre tabindex="0"><code>movie.csv
rating.csv
</code></pre><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span>$ head movie.csv
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#e6db74">&#34;movieId&#34;</span>,<span style="color:#e6db74">&#34;title&#34;</span>,<span style="color:#e6db74">&#34;genres&#34;</span>
</span></span><span style="display:flex;"><span>1,<span style="color:#e6db74">&#34;Toy Story (1995)&#34;</span>,<span style="color:#e6db74">&#34;Adventure|Animation|Children|Comedy|Fantasy&#34;</span>
</span></span><span style="display:flex;"><span>2,<span style="color:#e6db74">&#34;Jumanji (1995)&#34;</span>,<span style="color:#e6db74">&#34;Adventure|Children|Fantasy&#34;</span>
</span></span><span style="display:flex;"><span>3,<span style="color:#e6db74">&#34;Grumpier Old Men (1995)&#34;</span>,<span style="color:#e6db74">&#34;Comedy|Romance&#34;</span>
</span></span><span style="display:flex;"><span>4,<span style="color:#e6db74">&#34;Waiting to Exhale (1995)&#34;</span>,<span style="color:#e6db74">&#34;Comedy|Drama|Romance&#34;</span>
</span></span><span style="display:flex;"><span>5,<span style="color:#e6db74">&#34;Father of the Bride Part II (1995)&#34;</span>,<span style="color:#e6db74">&#34;Comedy&#34;</span>
</span></span><span style="display:flex;"><span>6,<span style="color:#e6db74">&#34;Heat (1995)&#34;</span>,<span style="color:#e6db74">&#34;Action|Crime|Thriller&#34;</span>
</span></span><span style="display:flex;"><span>7,<span style="color:#e6db74">&#34;Sabrina (1995)&#34;</span>,<span style="color:#e6db74">&#34;Comedy|Romance&#34;</span>
</span></span><span style="display:flex;"><span>8,<span style="color:#e6db74">&#34;Tom and Huck (1995)&#34;</span>,<span style="color:#e6db74">&#34;Adventure|Children&#34;</span>
</span></span><span style="display:flex;"><span>9,<span style="color:#e6db74">&#34;Sudden Death (1995)&#34;</span>,<span style="color:#e6db74">&#34;Action&#34;</span>
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span>$ head rating.csv
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#e6db74">&#34;userId&#34;</span>,<span style="color:#e6db74">&#34;movieId&#34;</span>,<span style="color:#e6db74">&#34;rating&#34;</span>,<span style="color:#e6db74">&#34;timestamp&#34;</span>
</span></span><span style="display:flex;"><span>1,2,3.5,2005-04-02 23:53:47
</span></span><span style="display:flex;"><span>1,29,3.5,2005-04-02 23:31:16
</span></span><span style="display:flex;"><span>1,32,3.5,2005-04-02 23:33:39
</span></span><span style="display:flex;"><span>1,47,3.5,2005-04-02 23:32:07
</span></span><span style="display:flex;"><span>1,50,3.5,2005-04-02 23:29:40
</span></span><span style="display:flex;"><span>1,112,3.5,2004-09-10 03:09:00
</span></span><span style="display:flex;"><span>1,151,4,2004-09-10 03:08:54
</span></span><span style="display:flex;"><span>1,223,4,2005-04-02 23:46:13
</span></span><span style="display:flex;"><span>1,253,4,2005-04-02 23:35:40
</span></span></code></pre></div><p>After trying to work with the datasets on my laptop using common ML tools and failing miserably due to lack of memory, I try the free Google Colab, and crash again with the same problem.</p>
<p>Well, I&rsquo;ll have to pay to do a test and that&rsquo;s it. No problem</p>
<p>But why not&hellip;</p>
<p>What if&hellip;?</p>
<h2 id="the-bad-idea">The bad idea</h2>
<p>Why not study how a collaborative filtering system works by coding it entirely instead of using already established and specialized libraries to do that job?</p>
<p>Well, because it&rsquo;s a waste of time.</p>
<p>But it can also be entertaining.</p>
<p>At least make a very simple one that only takes into account the most basic and limited functionalities, a stroke, a sketch, a nothing.</p>
<p>And also, I&rsquo;m going to do it&hellip; in SQL!</p>
<p>I start my trusty PostgreSQL and start the challenge. Without thinking too much about it because this is not for work, it is for hobby.</p>
<h3 id="tables">Tables</h3>
<p>I start by creating the <strong>movies</strong> table and loading the data from the <code>csv</code> file.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sql" data-lang="sql"><span style="display:flex;"><span><span style="color:#66d9ef">create</span> <span style="color:#66d9ef">table</span> movies
</span></span><span style="display:flex;"><span>(
</span></span><span style="display:flex;"><span>	id bigint <span style="color:#66d9ef">not</span> <span style="color:#66d9ef">null</span> <span style="color:#66d9ef">constraint</span> movies_pk <span style="color:#66d9ef">primary</span> <span style="color:#66d9ef">key</span>,
</span></span><span style="display:flex;"><span>	title varchar <span style="color:#66d9ef">not</span> <span style="color:#66d9ef">null</span>
</span></span><span style="display:flex;"><span>);
</span></span></code></pre></div><p>Same thing with the <strong>ratings</strong> table:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sql" data-lang="sql"><span style="display:flex;"><span><span style="color:#66d9ef">create</span> <span style="color:#66d9ef">table</span> ratings
</span></span><span style="display:flex;"><span>(
</span></span><span style="display:flex;"><span>	user_id bigint <span style="color:#66d9ef">not</span> <span style="color:#66d9ef">null</span>,
</span></span><span style="display:flex;"><span>	movie_id bigint <span style="color:#66d9ef">not</span> <span style="color:#66d9ef">null</span> <span style="color:#66d9ef">constraint</span> ratings_fk <span style="color:#66d9ef">references</span> movies,
</span></span><span style="display:flex;"><span>	rating numeric
</span></span><span style="display:flex;"><span>);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">create</span> <span style="color:#66d9ef">index</span> ratings_user_movie_id_idx <span style="color:#66d9ef">on</span> ratings (user_id, movie_id);
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">create</span> <span style="color:#66d9ef">index</span> ratings_user_id_idx <span style="color:#66d9ef">on</span> ratings (user_id);
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">create</span> <span style="color:#66d9ef">index</span> ratings_movie_id_idx <span style="color:#66d9ef">on</span> ratings (movie_id);
</span></span></code></pre></div><p>I also created an auxiliary table to store the user ids since, although I can query them from the ratings table if I need to, for performance reasons it is better to have them separately.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sql" data-lang="sql"><span style="display:flex;"><span><span style="color:#66d9ef">create</span> <span style="color:#66d9ef">table</span> rusers
</span></span><span style="display:flex;"><span>(
</span></span><span style="display:flex;"><span>	user_id bigint <span style="color:#66d9ef">not</span> <span style="color:#66d9ef">null</span> <span style="color:#66d9ef">constraint</span> rusers_pk <span style="color:#66d9ef">primary</span> <span style="color:#66d9ef">key</span>
</span></span><span style="display:flex;"><span>);
</span></span></code></pre></div><p>Create a function to populate this user table and run it.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sql" data-lang="sql"><span style="display:flex;"><span><span style="color:#66d9ef">create</span> <span style="color:#66d9ef">or</span> <span style="color:#66d9ef">replace</span> <span style="color:#66d9ef">function</span> fill_rusers() <span style="color:#66d9ef">returns</span> int
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">language</span> plpgsql
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">as</span> <span style="color:#960050;background-color:#1e0010">$$</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">declare</span>
</span></span><span style="display:flex;"><span>    f1 record;
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">begin</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">for</span> f1 <span style="color:#66d9ef">in</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">select</span> <span style="color:#66d9ef">distinct</span> user_id <span style="color:#66d9ef">from</span> ratings
</span></span><span style="display:flex;"><span>    loop
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">insert</span> <span style="color:#66d9ef">into</span> rusers (user_id) <span style="color:#66d9ef">values</span> (f1.user_id);
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">end</span> loop ;
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> <span style="color:#ae81ff">0</span>;
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">end</span>;
</span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">$$</span>
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sql" data-lang="sql"><span style="display:flex;"><span><span style="color:#66d9ef">select</span> fill_rusers();
</span></span></code></pre></div><h2 id="user-based-collaborative-filtering">User-based collaborative filtering</h2>
<p>I need to calculate the distance between users, so I create another table to store this information.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sql" data-lang="sql"><span style="display:flex;"><span><span style="color:#66d9ef">create</span> <span style="color:#66d9ef">table</span> user_distances
</span></span><span style="display:flex;"><span>(
</span></span><span style="display:flex;"><span>	user_a bigint <span style="color:#66d9ef">not</span> <span style="color:#66d9ef">null</span>,
</span></span><span style="display:flex;"><span>	user_b bigint <span style="color:#66d9ef">not</span> <span style="color:#66d9ef">null</span>,
</span></span><span style="display:flex;"><span>	distance numeric <span style="color:#66d9ef">not</span> <span style="color:#66d9ef">null</span>,
</span></span><span style="display:flex;"><span>	similarity numeric
</span></span><span style="display:flex;"><span>);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">create</span> <span style="color:#66d9ef">index</span> user_distances_user_b_index <span style="color:#66d9ef">on</span> user_distances (user_b);
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">create</span> <span style="color:#66d9ef">index</span> user_distances_user_a_index <span style="color:#66d9ef">on</span> user_distances (user_a);
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">create</span> <span style="color:#66d9ef">index</span> user_distances_user_a_b_index <span style="color:#66d9ef">on</span> user_distances (user_a, user_b);
</span></span></code></pre></div><p>Now a function to calculate the Euclidean distance between two users.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sql" data-lang="sql"><span style="display:flex;"><span><span style="color:#66d9ef">create</span> <span style="color:#66d9ef">or</span> <span style="color:#66d9ef">replace</span> <span style="color:#66d9ef">function</span> calc_eu_dist(user_a bigint, user_b bigint) <span style="color:#66d9ef">returns</span> decimal
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">language</span> plpgsql
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">as</span> <span style="color:#960050;background-color:#1e0010">$$</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">declare</span>
</span></span><span style="display:flex;"><span>    f record;
</span></span><span style="display:flex;"><span>    d decimal;
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">begin</span>
</span></span><span style="display:flex;"><span>    d <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>.<span style="color:#ae81ff">0</span>;
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">for</span> f <span style="color:#66d9ef">in</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">select</span> <span style="color:#f92672">*</span> <span style="color:#66d9ef">from</span> (
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">select</span> movie_id <span style="color:#66d9ef">as</span> movie_id_a, rating <span style="color:#66d9ef">as</span> rating_a <span style="color:#66d9ef">from</span> ratings <span style="color:#66d9ef">where</span> user_id <span style="color:#f92672">=</span> user_a
</span></span><span style="display:flex;"><span>        ) <span style="color:#66d9ef">as</span> r1
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">inner</span> <span style="color:#66d9ef">join</span> (
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">select</span> movie_id <span style="color:#66d9ef">as</span> movie_id_b, rating <span style="color:#66d9ef">as</span> rating_b <span style="color:#66d9ef">from</span> ratings <span style="color:#66d9ef">where</span> user_id <span style="color:#f92672">=</span> user_b
</span></span><span style="display:flex;"><span>        ) <span style="color:#66d9ef">as</span> r2
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">on</span> r1.movie_id_a <span style="color:#f92672">=</span> r2.movie_id_b
</span></span><span style="display:flex;"><span>    loop
</span></span><span style="display:flex;"><span>        d <span style="color:#f92672">=</span> d <span style="color:#f92672">+</span> (f.rating_a <span style="color:#f92672">-</span> f.rating_b)<span style="color:#f92672">^</span><span style="color:#ae81ff">2</span>;
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">end</span> loop ;
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> sqrt(d);
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">end</span>;
</span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">$$</span>
</span></span></code></pre></div><p>And another function to calculate the distance between all users and save it in the distance table.</p>
<p>For time and performance, since it is a toy and not a system intended to go to production, only the distances of the first 10 users with respect to all the others are calculated, but we could have them all by eliminating the condition of the first select (and waiting a long time until it finish).</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sql" data-lang="sql"><span style="display:flex;"><span><span style="color:#66d9ef">create</span> <span style="color:#66d9ef">or</span> <span style="color:#66d9ef">replace</span> <span style="color:#66d9ef">function</span> calc_user_distances() <span style="color:#66d9ef">returns</span> int
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">language</span> plpgsql
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">as</span> <span style="color:#960050;background-color:#1e0010">$$</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">declare</span>
</span></span><span style="display:flex;"><span>    f1 record;
</span></span><span style="display:flex;"><span>    f2 record;
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">begin</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">for</span> f1 <span style="color:#66d9ef">in</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">select</span> user_id <span style="color:#66d9ef">from</span> rusers <span style="color:#66d9ef">where</span> user_id <span style="color:#f92672">&lt;=</span> <span style="color:#ae81ff">10</span>
</span></span><span style="display:flex;"><span>    loop
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">for</span> f2 <span style="color:#66d9ef">in</span>
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">select</span> user_id <span style="color:#66d9ef">from</span> rusers <span style="color:#66d9ef">where</span> user_id <span style="color:#f92672">&lt;&gt;</span> f1.user_id
</span></span><span style="display:flex;"><span>        loop
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">insert</span> <span style="color:#66d9ef">into</span> user_distances (user_a, user_b, distance)
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">values</span> (f1.user_id, f2.user_id, calc_eu_dist(f1.user_id, f2.user_id));
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">end</span> loop;
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">end</span> loop ;
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> <span style="color:#ae81ff">0</span>;
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">end</span>;
</span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">$$</span>
</span></span></code></pre></div><p>Now, I can calculate the distance between users based on the rating they give to the movies.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sql" data-lang="sql"><span style="display:flex;"><span><span style="color:#66d9ef">select</span> calc_user_distances();
</span></span></code></pre></div><p>With this distance we can obtain the similarity between users taking into account the maximum distance that exists, and that we have just calculated. To obtain the similarity I also use a function.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sql" data-lang="sql"><span style="display:flex;"><span><span style="color:#66d9ef">create</span> <span style="color:#66d9ef">or</span> <span style="color:#66d9ef">replace</span> <span style="color:#66d9ef">function</span> calc_user_similarity() <span style="color:#66d9ef">returns</span> int
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">language</span> plpgsql
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">as</span> <span style="color:#960050;background-color:#1e0010">$$</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">declare</span>
</span></span><span style="display:flex;"><span>    f1 record;
</span></span><span style="display:flex;"><span>    max_dist decimal;
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">begin</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">select</span> <span style="color:#66d9ef">max</span>(distance) <span style="color:#66d9ef">into</span> max_dist <span style="color:#66d9ef">from</span> user_distances;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">for</span> f1 <span style="color:#66d9ef">in</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">select</span> user_a, user_b, distance <span style="color:#66d9ef">from</span> user_distances
</span></span><span style="display:flex;"><span>    loop
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">update</span> user_distances <span style="color:#66d9ef">set</span> similarity <span style="color:#f92672">=</span> (
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">case</span> <span style="color:#66d9ef">when</span> (f1.distance <span style="color:#f92672">&gt;</span> <span style="color:#ae81ff">0</span>.<span style="color:#ae81ff">0</span>) <span style="color:#66d9ef">then</span> (<span style="color:#ae81ff">1</span> <span style="color:#f92672">/</span> ((f1.distance<span style="color:#f92672">*</span><span style="color:#ae81ff">100</span>) <span style="color:#f92672">/</span> max_dist)) <span style="color:#66d9ef">else</span> <span style="color:#ae81ff">0</span> <span style="color:#66d9ef">end</span>
</span></span><span style="display:flex;"><span>        )
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">where</span> user_a <span style="color:#f92672">=</span> f1.user_a
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">and</span> user_b <span style="color:#f92672">=</span> f1.user_b;
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">end</span> loop;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> <span style="color:#ae81ff">0</span>;
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">end</span>;
</span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">$$</span>
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sql" data-lang="sql"><span style="display:flex;"><span><span style="color:#66d9ef">select</span> calc_user_similarity();
</span></span></code></pre></div><p>With this I have what is necessary to offer recommendations using a user-based collaborative filter making a query to the database.</p>
<p>Simply execute this query to obtain recommendations from a specific user. For example, for user 1:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sql" data-lang="sql"><span style="display:flex;"><span><span style="color:#66d9ef">select</span> m.id, m.title, <span style="color:#66d9ef">sum</span>(r.rating <span style="color:#f92672">*</span> ud.similarity) <span style="color:#66d9ef">as</span> final_score
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">from</span> ratings <span style="color:#66d9ef">as</span> r
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">inner</span> <span style="color:#66d9ef">join</span> movies <span style="color:#66d9ef">as</span> m <span style="color:#66d9ef">on</span> (r.movie_id <span style="color:#f92672">=</span> m.id)
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">inner</span> <span style="color:#66d9ef">join</span> user_distances <span style="color:#66d9ef">as</span> ud
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">on</span> r.user_id <span style="color:#f92672">=</span> ud.user_b
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">where</span> r.movie_id <span style="color:#66d9ef">not</span> <span style="color:#66d9ef">in</span> (
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">select</span> r2.movie_id <span style="color:#66d9ef">from</span> ratings <span style="color:#66d9ef">as</span> r2 <span style="color:#66d9ef">where</span> r2.user_id <span style="color:#f92672">=</span> <span style="color:#ae81ff">1</span>
</span></span><span style="display:flex;"><span>)
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">and</span> ud.user_a <span style="color:#f92672">=</span> <span style="color:#ae81ff">1</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">group</span> <span style="color:#66d9ef">by</span> m.id, m.title
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">order</span> <span style="color:#66d9ef">by</span> final_score <span style="color:#66d9ef">desc</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">limit</span> <span style="color:#ae81ff">10</span>
</span></span></code></pre></div><table>
<thead>
<tr>
<th>id</th>
<th>title</th>
<th>final_score</th>
</tr>
</thead>
<tbody>
<tr>
<td>356</td>
<td>Forrest Gump (1994)</td>
<td>26300.03735</td>
</tr>
<tr>
<td>480</td>
<td>Jurassic Park (1993)</td>
<td>20739.13908</td>
</tr>
<tr>
<td>527</td>
<td>Schindler&rsquo;s List (1993)</td>
<td>20165.20986</td>
</tr>
<tr>
<td>110</td>
<td>Braveheart (1995)</td>
<td>20147.55487</td>
</tr>
<tr>
<td>1</td>
<td>Toy Story (1995)</td>
<td>19933.39382</td>
</tr>
<tr>
<td>457</td>
<td>Fugitive, The (1993)</td>
<td>19491.59012</td>
</tr>
<tr>
<td>150</td>
<td>Apollo 13 (1995)</td>
<td>19318.55769</td>
</tr>
<tr>
<td>590</td>
<td>Dances with Wolves (1990)</td>
<td>17342.45445</td>
</tr>
<tr>
<td>780</td>
<td>Independence Day (a.k.a. ID4) (1996)</td>
<td>17024.60940</td>
</tr>
<tr>
<td>608</td>
<td>Fargo (1996)</td>
<td>16663.43452</td>
</tr>
</tbody>
</table>
<h2 id="item-based-collaborative-filtering">Item-based collaborative filtering</h2>
<p>Replicating the same work as in the previous section, but changing users for movies, I can obtain similarities between movies.</p>
<p>The table for the distances between films.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sql" data-lang="sql"><span style="display:flex;"><span><span style="color:#66d9ef">create</span> <span style="color:#66d9ef">table</span> movies_distances
</span></span><span style="display:flex;"><span>(
</span></span><span style="display:flex;"><span>	movie_a bigint <span style="color:#66d9ef">not</span> <span style="color:#66d9ef">null</span>,
</span></span><span style="display:flex;"><span>	movie_b bigint <span style="color:#66d9ef">not</span> <span style="color:#66d9ef">null</span>,
</span></span><span style="display:flex;"><span>	distance numeric <span style="color:#66d9ef">not</span> <span style="color:#66d9ef">null</span>,
</span></span><span style="display:flex;"><span>	similarity numeric
</span></span><span style="display:flex;"><span>);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">create</span> <span style="color:#66d9ef">index</span> movies_distances_b_index <span style="color:#66d9ef">on</span> movies_distances (movie_b);
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">create</span> <span style="color:#66d9ef">index</span> movies_distances_a_index <span style="color:#66d9ef">on</span> movies_distances (movie_a);
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">create</span> <span style="color:#66d9ef">index</span> movies_distances_a_b_index <span style="color:#66d9ef">on</span> movies_distances (movie_a, movie_b);
</span></span></code></pre></div><p>The function to calculate the Euclidean distance between the movies.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sql" data-lang="sql"><span style="display:flex;"><span><span style="color:#66d9ef">create</span> <span style="color:#66d9ef">or</span> <span style="color:#66d9ef">replace</span> <span style="color:#66d9ef">function</span> calc_eu_dist_movies(movie_a bigint, movie_b bigint) <span style="color:#66d9ef">returns</span> decimal
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">language</span> plpgsql
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">as</span> <span style="color:#960050;background-color:#1e0010">$$</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">declare</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">-- variables
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    f record;
</span></span><span style="display:flex;"><span>    d decimal;
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">begin</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">--body
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    d <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>.<span style="color:#ae81ff">0</span>;
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">for</span> f <span style="color:#66d9ef">in</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">select</span> <span style="color:#f92672">*</span> <span style="color:#66d9ef">from</span> (
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">select</span> user_id <span style="color:#66d9ef">as</span> user_id_a, rating <span style="color:#66d9ef">as</span> rating_a <span style="color:#66d9ef">from</span> ratings <span style="color:#66d9ef">where</span> movie_id <span style="color:#f92672">=</span> movie_a
</span></span><span style="display:flex;"><span>        ) <span style="color:#66d9ef">as</span> r1
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">inner</span> <span style="color:#66d9ef">join</span> (
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">select</span> user_id <span style="color:#66d9ef">as</span> user_id_b, rating <span style="color:#66d9ef">as</span> rating_b <span style="color:#66d9ef">from</span> ratings <span style="color:#66d9ef">where</span> movie_id <span style="color:#f92672">=</span> movie_b
</span></span><span style="display:flex;"><span>        ) <span style="color:#66d9ef">as</span> r2
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">on</span> r1.user_id_a <span style="color:#f92672">=</span> r2.user_id_b
</span></span><span style="display:flex;"><span>    loop
</span></span><span style="display:flex;"><span>        d <span style="color:#f92672">=</span> d <span style="color:#f92672">+</span> (f.rating_a <span style="color:#f92672">-</span> f.rating_b)<span style="color:#f92672">^</span><span style="color:#ae81ff">2</span>;
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">end</span> loop ;
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> sqrt(d);
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">end</span>;
</span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">$$</span>
</span></span></code></pre></div><p>The function to calculate the distance between movies and save them in the distance table. As in the previous section, we only calculate the distance of some films with respect to the others.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sql" data-lang="sql"><span style="display:flex;"><span><span style="color:#66d9ef">create</span> <span style="color:#66d9ef">or</span> <span style="color:#66d9ef">replace</span> <span style="color:#66d9ef">function</span> calc_movies_distances() <span style="color:#66d9ef">returns</span> int
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">language</span> plpgsql
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">as</span> <span style="color:#960050;background-color:#1e0010">$$</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">declare</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">-- variables
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    f1 record;
</span></span><span style="display:flex;"><span>    f2 record;
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">begin</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">--body
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">for</span> f1 <span style="color:#66d9ef">in</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">select</span> <span style="color:#66d9ef">distinct</span> movie_id <span style="color:#66d9ef">from</span> ratings <span style="color:#66d9ef">where</span> movie_id <span style="color:#f92672">&lt;=</span> <span style="color:#ae81ff">10</span>
</span></span><span style="display:flex;"><span>    loop
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">for</span> f2 <span style="color:#66d9ef">in</span>
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">select</span> <span style="color:#66d9ef">distinct</span> movie_id <span style="color:#66d9ef">from</span> ratings <span style="color:#66d9ef">where</span> movie_id <span style="color:#f92672">&lt;&gt;</span> f1.movie_id
</span></span><span style="display:flex;"><span>        loop
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">insert</span> <span style="color:#66d9ef">into</span> movies_distances (movie_a, movie_b, distance)
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">values</span> (f1.movie_id, f2.movie_id, calc_eu_dist_movies(f1.movie_id, f2.movie_id));
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">end</span> loop;
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">end</span> loop ;
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> <span style="color:#ae81ff">0</span>;
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">end</span>;
</span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">$$</span>
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sql" data-lang="sql"><span style="display:flex;"><span><span style="color:#66d9ef">select</span> calc_movies_distances();
</span></span></code></pre></div><p>Once the distances are obtained, calculate the similarity between movies and update the table with another function.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sql" data-lang="sql"><span style="display:flex;"><span><span style="color:#66d9ef">create</span> <span style="color:#66d9ef">or</span> <span style="color:#66d9ef">replace</span> <span style="color:#66d9ef">function</span> calc_movie_similarity() <span style="color:#66d9ef">returns</span> int
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">language</span> plpgsql
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">as</span> <span style="color:#960050;background-color:#1e0010">$$</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">declare</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">-- variables
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    f1 record;
</span></span><span style="display:flex;"><span>    max_dist decimal;
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">begin</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">--body
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#66d9ef">select</span> <span style="color:#66d9ef">max</span>(distance) <span style="color:#66d9ef">into</span> max_dist <span style="color:#66d9ef">from</span> movies_distances;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">for</span> f1 <span style="color:#66d9ef">in</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">select</span> movie_a, movie_b, distance <span style="color:#66d9ef">from</span> movies_distances
</span></span><span style="display:flex;"><span>    loop
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">update</span> movies_distances <span style="color:#66d9ef">set</span> similarity <span style="color:#f92672">=</span> (
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">case</span> <span style="color:#66d9ef">when</span> (f1.distance <span style="color:#f92672">&gt;</span> <span style="color:#ae81ff">0</span>.<span style="color:#ae81ff">0</span>) <span style="color:#66d9ef">then</span> (<span style="color:#ae81ff">1</span> <span style="color:#f92672">/</span> ((f1.distance<span style="color:#f92672">*</span><span style="color:#ae81ff">100</span>) <span style="color:#f92672">/</span> max_dist)) <span style="color:#66d9ef">else</span> <span style="color:#ae81ff">0</span> <span style="color:#66d9ef">end</span>
</span></span><span style="display:flex;"><span>        )
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">where</span> movie_a <span style="color:#f92672">=</span> f1.movie_a
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">and</span> movie_b <span style="color:#f92672">=</span> f1.movie_b;
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">end</span> loop;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> <span style="color:#ae81ff">0</span>;
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">end</span>;
</span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">$$</span>
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sql" data-lang="sql"><span style="display:flex;"><span><span style="color:#66d9ef">select</span> calc_movie_similarity();
</span></span></code></pre></div><p>A query to obtain the 10 most relevant recommendations according to a certain film</p>
<p>If we ask for recommendations based on the movie <strong>3 - Shadows in Paradise (Varjoja paratiisissa) (1986)</strong>:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sql" data-lang="sql"><span style="display:flex;"><span><span style="color:#66d9ef">select</span> m.id, m.title, <span style="color:#66d9ef">sum</span>(r.rating <span style="color:#f92672">*</span> md.similarity) <span style="color:#66d9ef">as</span> final_score
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">from</span> ratings <span style="color:#66d9ef">as</span> r
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">inner</span> <span style="color:#66d9ef">join</span> movies <span style="color:#66d9ef">as</span> m <span style="color:#66d9ef">on</span> (a.movie_id <span style="color:#f92672">=</span> m.id)
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">inner</span> <span style="color:#66d9ef">join</span> movies_distances <span style="color:#66d9ef">as</span> md
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">on</span> r.movie_id <span style="color:#f92672">=</span> md.movie_b
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">where</span> r.movie_id <span style="color:#66d9ef">not</span> <span style="color:#66d9ef">in</span> (
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">select</span> r2.movie_id <span style="color:#66d9ef">from</span> ratings <span style="color:#66d9ef">as</span> r2 <span style="color:#66d9ef">where</span> r2.movie_id <span style="color:#f92672">=</span> <span style="color:#ae81ff">3</span>
</span></span><span style="display:flex;"><span>)
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">and</span> md.movie_a <span style="color:#f92672">=</span> <span style="color:#ae81ff">3</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">group</span> <span style="color:#66d9ef">by</span> m.id, m.title
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">order</span> <span style="color:#66d9ef">by</span> final_score <span style="color:#66d9ef">desc</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">limit</span> <span style="color:#ae81ff">10</span>
</span></span></code></pre></div><table>
<thead>
<tr>
<th>id</th>
<th>title</th>
<th>final_score</th>
</tr>
</thead>
<tbody>
<tr>
<td>274</td>
<td>Silence of the Lambs, The (1991)</td>
<td>38976.71169</td>
</tr>
<tr>
<td>278</td>
<td>Shawshank Redemption, The (1994)</td>
<td>35165.68601</td>
</tr>
<tr>
<td>11</td>
<td>Star Wars: Episode IV - A New Hope (1977)</td>
<td>32377.39083</td>
</tr>
<tr>
<td>680</td>
<td>Pulp Fiction (1994)</td>
<td>30801.94301</td>
</tr>
<tr>
<td>14334</td>
<td>Secret of Roan Inish, The (1994)</td>
<td>30688.44737</td>
</tr>
<tr>
<td>629</td>
<td>Usual Suspects, The (1995)</td>
<td>29038.40834</td>
</tr>
<tr>
<td>19186</td>
<td>Parent Trap, The (1961)</td>
<td>28691.33482</td>
</tr>
<tr>
<td>13</td>
<td>Forrest Gump (1994)</td>
<td>27871.52393</td>
</tr>
<tr>
<td>1892</td>
<td>Star Wars: Episode VI - Return of the Jedi (1983)</td>
<td>27412.73468</td>
</tr>
<tr>
<td>424</td>
<td>Schindler&rsquo;s List (1993)</td>
<td>26701.82843</td>
</tr>
</tbody>
</table>
<hr>
<h2 id="conclusions">Conclusions</h2>
<p><strong>Advantages</strong></p>
<p>Few, but to say the least:</p>
<ul>
<li>Space is much cheaper and more abundant than memory.</li>
<li>It&rsquo;s cheaper (and maybe easier) to scale by making read replicas of the database than to build a new instance and load the model into memory.</li>
<li>&ldquo;Re-training&rdquo; the <em>model</em> is simply launching the functions to update the distances and list of recommendations, which can be executed for the specific items of a specific user when necessary (for example, if the user accepts one of the recommendations or by triggers). There is no need to repeat all function calls for all users and all movies.</li>
</ul>
<p><strong>Disadvantages</strong></p>
<ul>
<li>After creating the appropriate views, optimizing certain queries, and creating some indexes, when running the final queries the speed at which query results are returned is more acceptable, but is still too slow to be operational.</li>
<li>The mechanism is too simple, it does not have much added value nor does it take into account basic characteristics, such as the aging of scores.</li>
<li>Not very flexible: if we want to try different &ldquo;algorithms&rdquo; or systems, we have to redo a lot of the work.</li>
<li>We can only work with simple mechanisms, the complex algorithms currently used in ML are completely ruled out (although there are some interesting initiatives in this regard <a href="https://postgresml.org/">https://postgresml.org/</a>)</li>
</ul>
<p><strong>Final thoughts</strong></p>
<p>Well, I&rsquo;ve been entertained and found it interesting for a while, but that&rsquo;s it.</p>
<p>It&rsquo;s better to pay a little and do things properly.</p>
</article>
      </div>
      
    </div>
  </div>
</section>

  </div><footer class="footer">
  <div class="content has-text-centered">
    <p>Powered by <a href="https://gohugo.io">Hugo</a>. Theme <a href="https://github.com/wlh320/hugo-theme-hulga">Hulga</a></p>
    <p>
    
    </p>
  </div>
</footer>


  


<script src="https://cdn.jsdelivr.net/npm/vanilla-back-to-top@7.2.1/dist/vanilla-back-to-top.min.js"></script>

<script src="https://devjoyops.github.io/js/hulga.min.js" defer></script>

  
<link id="hlcss" rel="stylesheet" href="/css/monokai.min.css" type="text/css">
<script src="https://cdn.jsdelivr.net/npm/anchor-js@5.0.0/anchor.min.js"></script><script>
  anchors.options = {
    placement: 'left',
    
    icon: '#'
  };
  anchors.add('.content h1, .content h2, .content h3');
</script>


  

</body>

</html>
