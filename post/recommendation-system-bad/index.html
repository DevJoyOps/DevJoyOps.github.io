<!DOCTYPE html>
<html lang="en" dir="auto">

<head><meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<meta name="robots" content="index, follow">
<title>Recommendation system in the very, very wrong and ugly (but somehow funny) way | DevJoyOps</title>
<meta name="keywords" content="">
<meta name="description" content="The topic Studying how collaborative filtering recommendation systems work, I tried to do the typical movie recommendation system practice based on a Kaggle dataset. Specifically this:
https://www.kaggle.com/datasets/grouplens/movielens-20m-dataset
Once downloaded, the two interesting files to start exploring the topic are these two:
movie.csv rating.csv $ head movie.csv &#34;movieId&#34;,&#34;title&#34;,&#34;genres&#34; 1,&#34;Toy Story (1995)&#34;,&#34;Adventure|Animation|Children|Comedy|Fantasy&#34; 2,&#34;Jumanji (1995)&#34;,&#34;Adventure|Children|Fantasy&#34; 3,&#34;Grumpier Old Men (1995)&#34;,&#34;Comedy|Romance&#34; 4,&#34;Waiting to Exhale (1995)&#34;,&#34;Comedy|Drama|Romance&#34; 5,&#34;Father of the Bride Part II (1995)&#34;,&#34;Comedy&#34; 6,&#34;Heat (1995)&#34;,&#34;Action|Crime|Thriller&#34; 7,&#34;Sabrina (1995)&#34;,&#34;Comedy|Romance&#34; 8,&#34;Tom and Huck (1995)&#34;,&#34;Adventure|Children&#34; 9,&#34;Sudden Death (1995)&#34;,&#34;Action&#34; $ head rating.">
<meta name="author" content="">
<link rel="canonical" href="https://devjoyops.github.io/post/recommendation-system-bad/">
<link crossorigin="anonymous" href="/assets/css/stylesheet.b609c58d5c11bb90b1a54e04005d74ad1ddf22165eb79f5533967e57df9c3b50.css" integrity="sha256-tgnFjVwRu5CxpU4EAF10rR3fIhZet59VM5Z&#43;V9&#43;cO1A=" rel="preload stylesheet" as="style">
<link rel="icon" href="https://devjoyops.github.io/favicon.ico">
<link rel="icon" type="image/png" sizes="16x16" href="https://devjoyops.github.io/favicon-16x16.png">
<link rel="icon" type="image/png" sizes="32x32" href="https://devjoyops.github.io/favicon-32x32.png">
<link rel="apple-touch-icon" href="https://devjoyops.github.io/apple-touch-icon.png">
<link rel="mask-icon" href="https://devjoyops.github.io/safari-pinned-tab.svg">
<meta name="theme-color" content="#2e2e33">
<meta name="msapplication-TileColor" content="#2e2e33">
<link rel="alternate" hreflang="en" href="https://devjoyops.github.io/post/recommendation-system-bad/">
<noscript>
    <style>
        #theme-toggle,
        .top-link {
            display: none;
        }

    </style>
    <style>
        @media (prefers-color-scheme: dark) {
            :root {
                --theme: rgb(29, 30, 32);
                --entry: rgb(46, 46, 51);
                --primary: rgb(218, 218, 219);
                --secondary: rgb(155, 156, 157);
                --tertiary: rgb(65, 66, 68);
                --content: rgb(196, 196, 197);
                --code-block-bg: rgb(46, 46, 51);
                --code-bg: rgb(55, 56, 62);
                --border: rgb(51, 51, 51);
            }

            .list {
                background: var(--theme);
            }

            .list:not(.dark)::-webkit-scrollbar-track {
                background: 0 0;
            }

            .list:not(.dark)::-webkit-scrollbar-thumb {
                border-color: var(--theme);
            }
        }

    </style>
</noscript>
  

<meta property="og:title" content="Recommendation system in the very, very wrong and ugly (but somehow funny) way" />
<meta property="og:description" content="The topic Studying how collaborative filtering recommendation systems work, I tried to do the typical movie recommendation system practice based on a Kaggle dataset. Specifically this:
https://www.kaggle.com/datasets/grouplens/movielens-20m-dataset
Once downloaded, the two interesting files to start exploring the topic are these two:
movie.csv rating.csv $ head movie.csv &#34;movieId&#34;,&#34;title&#34;,&#34;genres&#34; 1,&#34;Toy Story (1995)&#34;,&#34;Adventure|Animation|Children|Comedy|Fantasy&#34; 2,&#34;Jumanji (1995)&#34;,&#34;Adventure|Children|Fantasy&#34; 3,&#34;Grumpier Old Men (1995)&#34;,&#34;Comedy|Romance&#34; 4,&#34;Waiting to Exhale (1995)&#34;,&#34;Comedy|Drama|Romance&#34; 5,&#34;Father of the Bride Part II (1995)&#34;,&#34;Comedy&#34; 6,&#34;Heat (1995)&#34;,&#34;Action|Crime|Thriller&#34; 7,&#34;Sabrina (1995)&#34;,&#34;Comedy|Romance&#34; 8,&#34;Tom and Huck (1995)&#34;,&#34;Adventure|Children&#34; 9,&#34;Sudden Death (1995)&#34;,&#34;Action&#34; $ head rating." />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://devjoyops.github.io/post/recommendation-system-bad/" /><meta property="article:section" content="post" />
<meta property="article:published_time" content="2024-05-27T18:41:55+02:00" />
<meta property="article:modified_time" content="2024-05-27T18:41:55+02:00" />

<meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="Recommendation system in the very, very wrong and ugly (but somehow funny) way"/>
<meta name="twitter:description" content="The topic Studying how collaborative filtering recommendation systems work, I tried to do the typical movie recommendation system practice based on a Kaggle dataset. Specifically this:
https://www.kaggle.com/datasets/grouplens/movielens-20m-dataset
Once downloaded, the two interesting files to start exploring the topic are these two:
movie.csv rating.csv $ head movie.csv &#34;movieId&#34;,&#34;title&#34;,&#34;genres&#34; 1,&#34;Toy Story (1995)&#34;,&#34;Adventure|Animation|Children|Comedy|Fantasy&#34; 2,&#34;Jumanji (1995)&#34;,&#34;Adventure|Children|Fantasy&#34; 3,&#34;Grumpier Old Men (1995)&#34;,&#34;Comedy|Romance&#34; 4,&#34;Waiting to Exhale (1995)&#34;,&#34;Comedy|Drama|Romance&#34; 5,&#34;Father of the Bride Part II (1995)&#34;,&#34;Comedy&#34; 6,&#34;Heat (1995)&#34;,&#34;Action|Crime|Thriller&#34; 7,&#34;Sabrina (1995)&#34;,&#34;Comedy|Romance&#34; 8,&#34;Tom and Huck (1995)&#34;,&#34;Adventure|Children&#34; 9,&#34;Sudden Death (1995)&#34;,&#34;Action&#34; $ head rating."/>


<script type="application/ld+json">
{
  "@context": "https://schema.org",
  "@type": "BreadcrumbList",
  "itemListElement": [
    {
      "@type": "ListItem",
      "position":  1 ,
      "name": "Posts",
      "item": "https://devjoyops.github.io/post/"
    }, 
    {
      "@type": "ListItem",
      "position":  2 ,
      "name": "Recommendation system in the very, very wrong and ugly (but somehow funny) way",
      "item": "https://devjoyops.github.io/post/recommendation-system-bad/"
    }
  ]
}
</script>
<script type="application/ld+json">
{
  "@context": "https://schema.org",
  "@type": "BlogPosting",
  "headline": "Recommendation system in the very, very wrong and ugly (but somehow funny) way",
  "name": "Recommendation system in the very, very wrong and ugly (but somehow funny) way",
  "description": "The topic Studying how collaborative filtering recommendation systems work, I tried to do the typical movie recommendation system practice based on a Kaggle dataset. Specifically this:\nhttps://www.kaggle.com/datasets/grouplens/movielens-20m-dataset\nOnce downloaded, the two interesting files to start exploring the topic are these two:\nmovie.csv rating.csv $ head movie.csv \u0026#34;movieId\u0026#34;,\u0026#34;title\u0026#34;,\u0026#34;genres\u0026#34; 1,\u0026#34;Toy Story (1995)\u0026#34;,\u0026#34;Adventure|Animation|Children|Comedy|Fantasy\u0026#34; 2,\u0026#34;Jumanji (1995)\u0026#34;,\u0026#34;Adventure|Children|Fantasy\u0026#34; 3,\u0026#34;Grumpier Old Men (1995)\u0026#34;,\u0026#34;Comedy|Romance\u0026#34; 4,\u0026#34;Waiting to Exhale (1995)\u0026#34;,\u0026#34;Comedy|Drama|Romance\u0026#34; 5,\u0026#34;Father of the Bride Part II (1995)\u0026#34;,\u0026#34;Comedy\u0026#34; 6,\u0026#34;Heat (1995)\u0026#34;,\u0026#34;Action|Crime|Thriller\u0026#34; 7,\u0026#34;Sabrina (1995)\u0026#34;,\u0026#34;Comedy|Romance\u0026#34; 8,\u0026#34;Tom and Huck (1995)\u0026#34;,\u0026#34;Adventure|Children\u0026#34; 9,\u0026#34;Sudden Death (1995)\u0026#34;,\u0026#34;Action\u0026#34; $ head rating.",
  "keywords": [
    
  ],
  "articleBody": "The topic Studying how collaborative filtering recommendation systems work, I tried to do the typical movie recommendation system practice based on a Kaggle dataset. Specifically this:\nhttps://www.kaggle.com/datasets/grouplens/movielens-20m-dataset\nOnce downloaded, the two interesting files to start exploring the topic are these two:\nmovie.csv rating.csv $ head movie.csv \"movieId\",\"title\",\"genres\" 1,\"Toy Story (1995)\",\"Adventure|Animation|Children|Comedy|Fantasy\" 2,\"Jumanji (1995)\",\"Adventure|Children|Fantasy\" 3,\"Grumpier Old Men (1995)\",\"Comedy|Romance\" 4,\"Waiting to Exhale (1995)\",\"Comedy|Drama|Romance\" 5,\"Father of the Bride Part II (1995)\",\"Comedy\" 6,\"Heat (1995)\",\"Action|Crime|Thriller\" 7,\"Sabrina (1995)\",\"Comedy|Romance\" 8,\"Tom and Huck (1995)\",\"Adventure|Children\" 9,\"Sudden Death (1995)\",\"Action\" $ head rating.csv \"userId\",\"movieId\",\"rating\",\"timestamp\" 1,2,3.5,2005-04-02 23:53:47 1,29,3.5,2005-04-02 23:31:16 1,32,3.5,2005-04-02 23:33:39 1,47,3.5,2005-04-02 23:32:07 1,50,3.5,2005-04-02 23:29:40 1,112,3.5,2004-09-10 03:09:00 1,151,4,2004-09-10 03:08:54 1,223,4,2005-04-02 23:46:13 1,253,4,2005-04-02 23:35:40 After trying to work with the datasets on my laptop using common ML tools and failing miserably due to lack of memory, I try the free Google Colab, and crash again with the same problem.\nWell, I’ll have to pay to do a test and that’s it. No problem\nBut why not…\nAnd if…?\nThe bad idea Why not study how a collaborative filtering system works by coding it entirely instead of using already established and specialized libraries to do that job?\nWell, because it’s a waste of time.\nBut it can also be entertaining.\nAt least make a very simple one that only takes into account the most basic and limited functionalities, a stroke, a sketch, a nothing.\nAnd also, I’m going to do it… in SQL!\nI start my trusty PostgreSQL and start the challenge. Without thinking too much about it because this is not work, it is a hobby.\nTables I start by creating the movies table and loading the data from the csv file.\ncreate table movies ( id bigint not null constraint movies_pk primary key, title varchar not null ); Same thing with the ratings table:\ncreate table ratings ( user_id bigint not null, movie_id bigint not null constraint ratings_fk references movies, rating numeric ); create index ratings_user_movie_id_idx on ratings (user_id, movie_id); create index ratings_user_id_idx on ratings (user_id); create index ratings_movie_id_idx on ratings (movie_id); I also created an auxiliary table to store the user ids since, although I can query them from the ratings table if I need to, for performance reasons it is better to have them separately.\ncreate table rusers ( user_id bigint not null constraint rusers_pk primary key ); Create a function to populate this user table and run it.\ncreate or replace function fill_rusers() returns int language plpgsql as $$ declare f1 record; begin for f1 in select distinct user_id from ratings loop insert into rusers (user_id) values (f1.user_id); end loop ; return 0; end; $$ select fill_rusers(); User-based collaborative filtering I’m going to need to calculate the distance between users, so I create another table to store this information.\ncreate table user_distances ( user_a bigint not null, user_b bigint not null, distance numeric not null, similarity numeric ); create index user_distances_user_b_index on user_distances (user_b); create index user_distances_user_a_index on user_distances (user_a); create index user_distances_user_a_b_index on user_distances (user_a, user_b); Now a function to calculate the Euclidean distance between two users.\ncreate or replace function calc_eu_dist(user_a bigint, user_b bigint) returns decimal language plpgsql as $$ declare f record; d decimal; begin d = 0.0; for f in select * from ( select movie_id as movie_id_a, rating as rating_a from ratings where user_id = user_a ) as r1 inner join ( select movie_id as movie_id_b, rating as rating_b from ratings where user_id = user_b ) as r2 on r1.movie_id_a = r2.movie_id_b loop d = d + (f.rating_a - f.rating_b)^2; end loop ; return sqrt(d); end; $$ And another function to calculate the distance between all users and save it in the distance table.\nFor time and performance, since it is a toy and not a system intended to go to production, only the distances of the first 10 users with respect to all the others are calculated, but we could have them all by eliminating the condition of the first select (and waiting a long time until it finish).\ncreate or replace function calc_user_distances() returns int language plpgsql as $$ declare f1 record; f2 record; begin for f1 in select user_id from rusers where user_id \u003c= 10 loop for f2 in select user_id from rusers where user_id \u003c\u003e f1.user_id loop insert into user_distances (user_a, user_b, distance) values (f1.user_id, f2.user_id, calc_eu_dist(f1.user_id, f2.user_id)); end loop; end loop ; return 0; end; $$ Now, I can calculate the distance between users based on the rating they give to the movies.\nselect calc_user_distances(); With this distance we can obtain the similarity between users taking into account the maximum distance that exists, and that we have just calculated. To obtain the similarity I also use a function.\ncreate or replace function calc_user_similarity() returns int language plpgsql as $$ declare f1 record; max_dist decimal; begin select max(distance) into max_dist from user_distances; for f1 in select user_a, user_b, distance from user_distances loop update user_distances set similarity = ( case when (f1.distance \u003e 0.0) then (1 / ((f1.distance*100) / max_dist)) else 0 end ) where user_a = f1.user_a and user_b = f1.user_b; end loop; return 0; end; $$ select calc_user_similarity(); With this I have what is necessary to offer recommendations using a user-based collaborative filter making a query to the database.\nSimply execute this query to obtain recommendations from a specific user. For example, for user 1:\nselect m.id, m.title, sum(r.rating * ud.similarity) as final_score from ratings as r inner join movies as m on (r.movie_id = m.id) inner join user_distances as ud on r.user_id = ud.user_b where r.movie_id not in ( select r2.movie_id from ratings as r2 where r2.user_id = 1 ) and ud.user_a = 1 group by m.id, m.title order by final_score desc limit 10 id title final_score 356 Forrest Gump (1994) 26300.03735 480 Jurassic Park (1993) 20739.13908 527 Schindler’s List (1993) 20165.20986 110 Braveheart (1995) 20147.55487 1 Toy Story (1995) 19933.39382 457 Fugitive, The (1993) 19491.59012 150 Apollo 13 (1995) 19318.55769 590 Dances with Wolves (1990) 17342.45445 780 Independence Day (a.k.a. ID4) (1996) 17024.60940 608 Fargo (1996) 16663.43452 Item-based collaborative filtering Replicating the same work as in the previous section, but changing users for movies, I can obtain similarities between movies.\nThe table for the distances between films.\ncreate table movies_distances ( movie_a bigint not null, movie_b bigint not null, distance numeric not null, similarity numeric ); create index movies_distances_b_index on movies_distances (movie_b); create index movies_distances_a_index on movies_distances (movie_a); create index movies_distances_a_b_index on movies_distances (movie_a, movie_b); The function to calculate the Euclidean distance between the movies.\ncreate or replace function calc_eu_dist_movies(movie_a bigint, movie_b bigint) returns decimal language plpgsql as $$ declare -- variables f record; d decimal; begin --body d = 0.0; for f in select * from ( select user_id as user_id_a, rating as rating_a from ratings where movie_id = movie_a ) as r1 inner join ( select user_id as user_id_b, rating as rating_b from ratings where movie_id = movie_b ) as r2 on r1.user_id_a = r2.user_id_b loop d = d + (f.rating_a - f.rating_b)^2; end loop ; return sqrt(d); end; $$ The function to calculate the distance between movies and save them in the distance table. As in the previous section, we only calculate the distance of some films with respect to the others.\ncreate or replace function calc_movies_distances() returns int language plpgsql as $$ declare -- variables f1 record; f2 record; begin --body for f1 in select distinct movie_id from ratings where movie_id \u003c= 10 loop for f2 in select distinct movie_id from ratings where movie_id \u003c\u003e f1.movie_id loop insert into movies_distances (movie_a, movie_b, distance) values (f1.movie_id, f2.movie_id, calc_eu_dist_movies(f1.movie_id, f2.movie_id)); end loop; end loop ; return 0; end; $$ select calc_movies_distances(); Once the distances are obtained, calculate the similarity between movies and update the table with another function.\ncreate or replace function calc_movie_similarity() returns int language plpgsql as $$ declare -- variables f1 record; max_dist decimal; begin --body select max(distance) into max_dist from movies_distances; for f1 in select movie_a, movie_b, distance from movies_distances loop update movies_distances set similarity = ( case when (f1.distance \u003e 0.0) then (1 / ((f1.distance*100) / max_dist)) else 0 end ) where movie_a = f1.movie_a and movie_b = f1.movie_b; end loop; return 0; end; $$ select calc_movie_similarity(); A query to obtain the 10 most relevant recommendations according to a certain film\nIf we ask for recommendations based on the movie 3 - Shadows in Paradise (Varjoja paratiisissa) (1986):\nselect m.id, m.title, sum(r.rating * md.similarity) as final_score from ratings as r inner join movies as m on (a.movie_id = m.id) inner join movies_distances as md on r.movie_id = md.movie_b where r.movie_id not in ( select r2.movie_id from ratings as r2 where r2.movie_id = 3 ) and md.movie_a = 3 group by m.id, m.title order by final_score desc limit 10 id title final_score 274 Silence of the Lambs, The (1991) 38976.71169 278 Shawshank Redemption, The (1994) 35165.68601 11 Star Wars: Episode IV - A New Hope (1977) 32377.39083 680 Pulp Fiction (1994) 30801.94301 14334 Secret of Roan Inish, The (1994) 30688.44737 629 Usual Suspects, The (1995) 29038.40834 19186 Parent Trap, The (1961) 28691.33482 13 Forrest Gump (1994) 27871.52393 1892 Star Wars: Episode VI - Return of the Jedi (1983) 27412.73468 424 Schindler’s List (1993) 26701.82843 Conclusions Advantages\nFew, but to say the least:\nSpace is much cheaper and more abundant than memory. It’s cheaper (and maybe easier) to scale by making read replicas of the database than to build a new instance and load the model into memory. “Re-training” the model is simply launching the functions to update the distances and list of recommendations, which can be executed for the specific items of a specific user when necessary (for example, if the user accepts one of the recommendations or by triggers). There is no need to repeat all function calls for all users and all movies. Disadvantages\nAfter creating the appropriate views, optimizing certain queries, and creating some indexes, when running the final queries the speed at which query results are returned is more acceptable, but is still too slow to be operational. The mechanism is too simple, it does not have much added value nor does it take into account basic characteristics, such as the aging of scores. Not very flexible: if we want to try different “algorithms” or systems, we have to redo a lot of the work. We can only work with simple mechanisms, the complex algorithms currently used in ML are completely ruled out (although there are some interesting initiatives in this regard https://postgresml.org/) Final thoughts\nWell, I’ve been entertained and found it interesting for a while, but that’s it.\nIt’s better to pay a little and do things properly.\n",
  "wordCount" : "1750",
  "inLanguage": "en",
  "datePublished": "2024-05-27T18:41:55+02:00",
  "dateModified": "2024-05-27T18:41:55+02:00",
  "mainEntityOfPage": {
    "@type": "WebPage",
    "@id": "https://devjoyops.github.io/post/recommendation-system-bad/"
  },
  "publisher": {
    "@type": "Organization",
    "name": "DevJoyOps",
    "logo": {
      "@type": "ImageObject",
      "url": "https://devjoyops.github.io/favicon.ico"
    }
  }
}
</script>
</head>

<body class="" id="top">
<script>
    if (localStorage.getItem("pref-theme") === "dark") {
        document.body.classList.add('dark');
    } else if (localStorage.getItem("pref-theme") === "light") {
        document.body.classList.remove('dark')
    } else if (window.matchMedia('(prefers-color-scheme: dark)').matches) {
        document.body.classList.add('dark');
    }

</script>

<header class="header">
    <nav class="nav">
        <div class="logo">
            <a href="https://devjoyops.github.io/" accesskey="h" title="DevJoyOps (Alt + H)">DevJoyOps</a>
            <div class="logo-switches">
                <button id="theme-toggle" accesskey="t" title="(Alt + T)">
                    <svg id="moon" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24"
                        fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                        stroke-linejoin="round">
                        <path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"></path>
                    </svg>
                    <svg id="sun" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24"
                        fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                        stroke-linejoin="round">
                        <circle cx="12" cy="12" r="5"></circle>
                        <line x1="12" y1="1" x2="12" y2="3"></line>
                        <line x1="12" y1="21" x2="12" y2="23"></line>
                        <line x1="4.22" y1="4.22" x2="5.64" y2="5.64"></line>
                        <line x1="18.36" y1="18.36" x2="19.78" y2="19.78"></line>
                        <line x1="1" y1="12" x2="3" y2="12"></line>
                        <line x1="21" y1="12" x2="23" y2="12"></line>
                        <line x1="4.22" y1="19.78" x2="5.64" y2="18.36"></line>
                        <line x1="18.36" y1="5.64" x2="19.78" y2="4.22"></line>
                    </svg>
                </button>
            </div>
        </div>
        <ul id="menu">
        </ul>
    </nav>
</header>
<main class="main">

<article class="post-single">
  <header class="post-header">
    
    <h1 class="post-title entry-hint-parent">
      Recommendation system in the very, very wrong and ugly (but somehow funny) way
    </h1>
    <div class="post-meta"><span title='2024-05-27 18:41:55 +0200 CEST'>May 27, 2024</span>

</div>
  </header> 
  <div class="post-content"><h2 id="the-topic">The topic<a hidden class="anchor" aria-hidden="true" href="#the-topic">#</a></h2>
<p>Studying how collaborative filtering recommendation systems work, I tried to do the typical movie recommendation system practice based on a Kaggle dataset. Specifically this:</p>
<blockquote>
<p><a href="https://www.kaggle.com/datasets/grouplens/movielens-20m-dataset">https://www.kaggle.com/datasets/grouplens/movielens-20m-dataset</a></p>
</blockquote>
<p>Once downloaded, the two interesting files to start exploring the topic are these two:</p>
<pre tabindex="0"><code>movie.csv
rating.csv
</code></pre><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span>$ head movie.csv
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#e6db74">&#34;movieId&#34;</span>,<span style="color:#e6db74">&#34;title&#34;</span>,<span style="color:#e6db74">&#34;genres&#34;</span>
</span></span><span style="display:flex;"><span>1,<span style="color:#e6db74">&#34;Toy Story (1995)&#34;</span>,<span style="color:#e6db74">&#34;Adventure|Animation|Children|Comedy|Fantasy&#34;</span>
</span></span><span style="display:flex;"><span>2,<span style="color:#e6db74">&#34;Jumanji (1995)&#34;</span>,<span style="color:#e6db74">&#34;Adventure|Children|Fantasy&#34;</span>
</span></span><span style="display:flex;"><span>3,<span style="color:#e6db74">&#34;Grumpier Old Men (1995)&#34;</span>,<span style="color:#e6db74">&#34;Comedy|Romance&#34;</span>
</span></span><span style="display:flex;"><span>4,<span style="color:#e6db74">&#34;Waiting to Exhale (1995)&#34;</span>,<span style="color:#e6db74">&#34;Comedy|Drama|Romance&#34;</span>
</span></span><span style="display:flex;"><span>5,<span style="color:#e6db74">&#34;Father of the Bride Part II (1995)&#34;</span>,<span style="color:#e6db74">&#34;Comedy&#34;</span>
</span></span><span style="display:flex;"><span>6,<span style="color:#e6db74">&#34;Heat (1995)&#34;</span>,<span style="color:#e6db74">&#34;Action|Crime|Thriller&#34;</span>
</span></span><span style="display:flex;"><span>7,<span style="color:#e6db74">&#34;Sabrina (1995)&#34;</span>,<span style="color:#e6db74">&#34;Comedy|Romance&#34;</span>
</span></span><span style="display:flex;"><span>8,<span style="color:#e6db74">&#34;Tom and Huck (1995)&#34;</span>,<span style="color:#e6db74">&#34;Adventure|Children&#34;</span>
</span></span><span style="display:flex;"><span>9,<span style="color:#e6db74">&#34;Sudden Death (1995)&#34;</span>,<span style="color:#e6db74">&#34;Action&#34;</span>
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span>$ head rating.csv
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#e6db74">&#34;userId&#34;</span>,<span style="color:#e6db74">&#34;movieId&#34;</span>,<span style="color:#e6db74">&#34;rating&#34;</span>,<span style="color:#e6db74">&#34;timestamp&#34;</span>
</span></span><span style="display:flex;"><span>1,2,3.5,2005-04-02 23:53:47
</span></span><span style="display:flex;"><span>1,29,3.5,2005-04-02 23:31:16
</span></span><span style="display:flex;"><span>1,32,3.5,2005-04-02 23:33:39
</span></span><span style="display:flex;"><span>1,47,3.5,2005-04-02 23:32:07
</span></span><span style="display:flex;"><span>1,50,3.5,2005-04-02 23:29:40
</span></span><span style="display:flex;"><span>1,112,3.5,2004-09-10 03:09:00
</span></span><span style="display:flex;"><span>1,151,4,2004-09-10 03:08:54
</span></span><span style="display:flex;"><span>1,223,4,2005-04-02 23:46:13
</span></span><span style="display:flex;"><span>1,253,4,2005-04-02 23:35:40
</span></span></code></pre></div><p>After trying to work with the datasets on my laptop using common ML tools and failing miserably due to lack of memory, I try the free Google Colab, and crash again with the same problem.</p>
<p>Well, I&rsquo;ll have to pay to do a test and that&rsquo;s it. No problem</p>
<p>But why not&hellip;</p>
<p>And if&hellip;?</p>
<h2 id="the-bad-idea">The bad idea<a hidden class="anchor" aria-hidden="true" href="#the-bad-idea">#</a></h2>
<p>Why not study how a collaborative filtering system works by coding it entirely instead of using already established and specialized libraries to do that job?</p>
<p>Well, because it&rsquo;s a waste of time.</p>
<p>But it can also be entertaining.</p>
<p>At least make a very simple one that only takes into account the most basic and limited functionalities, a stroke, a sketch, a nothing.</p>
<p>And also, I&rsquo;m going to do it&hellip; in SQL!</p>
<p>I start my trusty PostgreSQL and start the challenge. Without thinking too much about it because this is not work, it is a hobby.</p>
<h3 id="tables">Tables<a hidden class="anchor" aria-hidden="true" href="#tables">#</a></h3>
<p>I start by creating the <strong>movies</strong> table and loading the data from the <code>csv</code> file.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sql" data-lang="sql"><span style="display:flex;"><span><span style="color:#66d9ef">create</span> <span style="color:#66d9ef">table</span> movies
</span></span><span style="display:flex;"><span>(
</span></span><span style="display:flex;"><span>	id bigint <span style="color:#66d9ef">not</span> <span style="color:#66d9ef">null</span> <span style="color:#66d9ef">constraint</span> movies_pk <span style="color:#66d9ef">primary</span> <span style="color:#66d9ef">key</span>,
</span></span><span style="display:flex;"><span>	title varchar <span style="color:#66d9ef">not</span> <span style="color:#66d9ef">null</span>
</span></span><span style="display:flex;"><span>);
</span></span></code></pre></div><p>Same thing with the <strong>ratings</strong> table:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sql" data-lang="sql"><span style="display:flex;"><span><span style="color:#66d9ef">create</span> <span style="color:#66d9ef">table</span> ratings
</span></span><span style="display:flex;"><span>(
</span></span><span style="display:flex;"><span>	user_id bigint <span style="color:#66d9ef">not</span> <span style="color:#66d9ef">null</span>,
</span></span><span style="display:flex;"><span>	movie_id bigint <span style="color:#66d9ef">not</span> <span style="color:#66d9ef">null</span> <span style="color:#66d9ef">constraint</span> ratings_fk <span style="color:#66d9ef">references</span> movies,
</span></span><span style="display:flex;"><span>	rating numeric
</span></span><span style="display:flex;"><span>);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">create</span> <span style="color:#66d9ef">index</span> ratings_user_movie_id_idx <span style="color:#66d9ef">on</span> ratings (user_id, movie_id);
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">create</span> <span style="color:#66d9ef">index</span> ratings_user_id_idx <span style="color:#66d9ef">on</span> ratings (user_id);
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">create</span> <span style="color:#66d9ef">index</span> ratings_movie_id_idx <span style="color:#66d9ef">on</span> ratings (movie_id);
</span></span></code></pre></div><p>I also created an auxiliary table to store the user ids since, although I can query them from the ratings table if I need to, for performance reasons it is better to have them separately.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sql" data-lang="sql"><span style="display:flex;"><span><span style="color:#66d9ef">create</span> <span style="color:#66d9ef">table</span> rusers
</span></span><span style="display:flex;"><span>(
</span></span><span style="display:flex;"><span>	user_id bigint <span style="color:#66d9ef">not</span> <span style="color:#66d9ef">null</span> <span style="color:#66d9ef">constraint</span> rusers_pk <span style="color:#66d9ef">primary</span> <span style="color:#66d9ef">key</span>
</span></span><span style="display:flex;"><span>);
</span></span></code></pre></div><p>Create a function to populate this user table and run it.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sql" data-lang="sql"><span style="display:flex;"><span><span style="color:#66d9ef">create</span> <span style="color:#66d9ef">or</span> <span style="color:#66d9ef">replace</span> <span style="color:#66d9ef">function</span> fill_rusers() <span style="color:#66d9ef">returns</span> int
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">language</span> plpgsql
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">as</span> <span style="color:#960050;background-color:#1e0010">$$</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">declare</span>
</span></span><span style="display:flex;"><span>    f1 record;
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">begin</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">for</span> f1 <span style="color:#66d9ef">in</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">select</span> <span style="color:#66d9ef">distinct</span> user_id <span style="color:#66d9ef">from</span> ratings
</span></span><span style="display:flex;"><span>    loop
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">insert</span> <span style="color:#66d9ef">into</span> rusers (user_id) <span style="color:#66d9ef">values</span> (f1.user_id);
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">end</span> loop ;
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> <span style="color:#ae81ff">0</span>;
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">end</span>;
</span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">$$</span>
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sql" data-lang="sql"><span style="display:flex;"><span><span style="color:#66d9ef">select</span> fill_rusers();
</span></span></code></pre></div><h2 id="user-based-collaborative-filtering">User-based collaborative filtering<a hidden class="anchor" aria-hidden="true" href="#user-based-collaborative-filtering">#</a></h2>
<p>I&rsquo;m going to need to calculate the distance between users, so I create another table to store this information.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sql" data-lang="sql"><span style="display:flex;"><span><span style="color:#66d9ef">create</span> <span style="color:#66d9ef">table</span> user_distances
</span></span><span style="display:flex;"><span>(
</span></span><span style="display:flex;"><span>	user_a bigint <span style="color:#66d9ef">not</span> <span style="color:#66d9ef">null</span>,
</span></span><span style="display:flex;"><span>	user_b bigint <span style="color:#66d9ef">not</span> <span style="color:#66d9ef">null</span>,
</span></span><span style="display:flex;"><span>	distance numeric <span style="color:#66d9ef">not</span> <span style="color:#66d9ef">null</span>,
</span></span><span style="display:flex;"><span>	similarity numeric
</span></span><span style="display:flex;"><span>);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">create</span> <span style="color:#66d9ef">index</span> user_distances_user_b_index <span style="color:#66d9ef">on</span> user_distances (user_b);
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">create</span> <span style="color:#66d9ef">index</span> user_distances_user_a_index <span style="color:#66d9ef">on</span> user_distances (user_a);
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">create</span> <span style="color:#66d9ef">index</span> user_distances_user_a_b_index <span style="color:#66d9ef">on</span> user_distances (user_a, user_b);
</span></span></code></pre></div><p>Now a function to calculate the Euclidean distance between two users.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sql" data-lang="sql"><span style="display:flex;"><span><span style="color:#66d9ef">create</span> <span style="color:#66d9ef">or</span> <span style="color:#66d9ef">replace</span> <span style="color:#66d9ef">function</span> calc_eu_dist(user_a bigint, user_b bigint) <span style="color:#66d9ef">returns</span> decimal
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">language</span> plpgsql
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">as</span> <span style="color:#960050;background-color:#1e0010">$$</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">declare</span>
</span></span><span style="display:flex;"><span>    f record;
</span></span><span style="display:flex;"><span>    d decimal;
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">begin</span>
</span></span><span style="display:flex;"><span>    d <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>.<span style="color:#ae81ff">0</span>;
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">for</span> f <span style="color:#66d9ef">in</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">select</span> <span style="color:#f92672">*</span> <span style="color:#66d9ef">from</span> (
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">select</span> movie_id <span style="color:#66d9ef">as</span> movie_id_a, rating <span style="color:#66d9ef">as</span> rating_a <span style="color:#66d9ef">from</span> ratings <span style="color:#66d9ef">where</span> user_id <span style="color:#f92672">=</span> user_a
</span></span><span style="display:flex;"><span>        ) <span style="color:#66d9ef">as</span> r1
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">inner</span> <span style="color:#66d9ef">join</span> (
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">select</span> movie_id <span style="color:#66d9ef">as</span> movie_id_b, rating <span style="color:#66d9ef">as</span> rating_b <span style="color:#66d9ef">from</span> ratings <span style="color:#66d9ef">where</span> user_id <span style="color:#f92672">=</span> user_b
</span></span><span style="display:flex;"><span>        ) <span style="color:#66d9ef">as</span> r2
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">on</span> r1.movie_id_a <span style="color:#f92672">=</span> r2.movie_id_b
</span></span><span style="display:flex;"><span>    loop
</span></span><span style="display:flex;"><span>        d <span style="color:#f92672">=</span> d <span style="color:#f92672">+</span> (f.rating_a <span style="color:#f92672">-</span> f.rating_b)<span style="color:#f92672">^</span><span style="color:#ae81ff">2</span>;
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">end</span> loop ;
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> sqrt(d);
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">end</span>;
</span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">$$</span>
</span></span></code></pre></div><p>And another function to calculate the distance between all users and save it in the distance table.</p>
<p>For time and performance, since it is a toy and not a system intended to go to production, only the distances of the first 10 users with respect to all the others are calculated, but we could have them all by eliminating the condition of the first select (and waiting a long time until it finish).</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sql" data-lang="sql"><span style="display:flex;"><span><span style="color:#66d9ef">create</span> <span style="color:#66d9ef">or</span> <span style="color:#66d9ef">replace</span> <span style="color:#66d9ef">function</span> calc_user_distances() <span style="color:#66d9ef">returns</span> int
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">language</span> plpgsql
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">as</span> <span style="color:#960050;background-color:#1e0010">$$</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">declare</span>
</span></span><span style="display:flex;"><span>    f1 record;
</span></span><span style="display:flex;"><span>    f2 record;
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">begin</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">for</span> f1 <span style="color:#66d9ef">in</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">select</span> user_id <span style="color:#66d9ef">from</span> rusers <span style="color:#66d9ef">where</span> user_id <span style="color:#f92672">&lt;=</span> <span style="color:#ae81ff">10</span>
</span></span><span style="display:flex;"><span>    loop
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">for</span> f2 <span style="color:#66d9ef">in</span>
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">select</span> user_id <span style="color:#66d9ef">from</span> rusers <span style="color:#66d9ef">where</span> user_id <span style="color:#f92672">&lt;&gt;</span> f1.user_id
</span></span><span style="display:flex;"><span>        loop
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">insert</span> <span style="color:#66d9ef">into</span> user_distances (user_a, user_b, distance)
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">values</span> (f1.user_id, f2.user_id, calc_eu_dist(f1.user_id, f2.user_id));
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">end</span> loop;
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">end</span> loop ;
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> <span style="color:#ae81ff">0</span>;
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">end</span>;
</span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">$$</span>
</span></span></code></pre></div><p>Now, I can calculate the distance between users based on the rating they give to the movies.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sql" data-lang="sql"><span style="display:flex;"><span><span style="color:#66d9ef">select</span> calc_user_distances();
</span></span></code></pre></div><p>With this distance we can obtain the similarity between users taking into account the maximum distance that exists, and that we have just calculated. To obtain the similarity I also use a function.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sql" data-lang="sql"><span style="display:flex;"><span><span style="color:#66d9ef">create</span> <span style="color:#66d9ef">or</span> <span style="color:#66d9ef">replace</span> <span style="color:#66d9ef">function</span> calc_user_similarity() <span style="color:#66d9ef">returns</span> int
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">language</span> plpgsql
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">as</span> <span style="color:#960050;background-color:#1e0010">$$</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">declare</span>
</span></span><span style="display:flex;"><span>    f1 record;
</span></span><span style="display:flex;"><span>    max_dist decimal;
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">begin</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">select</span> <span style="color:#66d9ef">max</span>(distance) <span style="color:#66d9ef">into</span> max_dist <span style="color:#66d9ef">from</span> user_distances;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">for</span> f1 <span style="color:#66d9ef">in</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">select</span> user_a, user_b, distance <span style="color:#66d9ef">from</span> user_distances
</span></span><span style="display:flex;"><span>    loop
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">update</span> user_distances <span style="color:#66d9ef">set</span> similarity <span style="color:#f92672">=</span> (
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">case</span> <span style="color:#66d9ef">when</span> (f1.distance <span style="color:#f92672">&gt;</span> <span style="color:#ae81ff">0</span>.<span style="color:#ae81ff">0</span>) <span style="color:#66d9ef">then</span> (<span style="color:#ae81ff">1</span> <span style="color:#f92672">/</span> ((f1.distance<span style="color:#f92672">*</span><span style="color:#ae81ff">100</span>) <span style="color:#f92672">/</span> max_dist)) <span style="color:#66d9ef">else</span> <span style="color:#ae81ff">0</span> <span style="color:#66d9ef">end</span>
</span></span><span style="display:flex;"><span>        )
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">where</span> user_a <span style="color:#f92672">=</span> f1.user_a
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">and</span> user_b <span style="color:#f92672">=</span> f1.user_b;
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">end</span> loop;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> <span style="color:#ae81ff">0</span>;
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">end</span>;
</span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">$$</span>
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sql" data-lang="sql"><span style="display:flex;"><span><span style="color:#66d9ef">select</span> calc_user_similarity();
</span></span></code></pre></div><p>With this I have what is necessary to offer recommendations using a user-based collaborative filter making a query to the database.</p>
<p>Simply execute this query to obtain recommendations from a specific user. For example, for user 1:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sql" data-lang="sql"><span style="display:flex;"><span><span style="color:#66d9ef">select</span> m.id, m.title, <span style="color:#66d9ef">sum</span>(r.rating <span style="color:#f92672">*</span> ud.similarity) <span style="color:#66d9ef">as</span> final_score
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">from</span> ratings <span style="color:#66d9ef">as</span> r
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">inner</span> <span style="color:#66d9ef">join</span> movies <span style="color:#66d9ef">as</span> m <span style="color:#66d9ef">on</span> (r.movie_id <span style="color:#f92672">=</span> m.id)
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">inner</span> <span style="color:#66d9ef">join</span> user_distances <span style="color:#66d9ef">as</span> ud
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">on</span> r.user_id <span style="color:#f92672">=</span> ud.user_b
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">where</span> r.movie_id <span style="color:#66d9ef">not</span> <span style="color:#66d9ef">in</span> (
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">select</span> r2.movie_id <span style="color:#66d9ef">from</span> ratings <span style="color:#66d9ef">as</span> r2 <span style="color:#66d9ef">where</span> r2.user_id <span style="color:#f92672">=</span> <span style="color:#ae81ff">1</span>
</span></span><span style="display:flex;"><span>)
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">and</span> ud.user_a <span style="color:#f92672">=</span> <span style="color:#ae81ff">1</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">group</span> <span style="color:#66d9ef">by</span> m.id, m.title
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">order</span> <span style="color:#66d9ef">by</span> final_score <span style="color:#66d9ef">desc</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">limit</span> <span style="color:#ae81ff">10</span>
</span></span></code></pre></div><table>
<thead>
<tr>
<th>id</th>
<th>title</th>
<th>final_score</th>
</tr>
</thead>
<tbody>
<tr>
<td>356</td>
<td>Forrest Gump (1994)</td>
<td>26300.03735</td>
</tr>
<tr>
<td>480</td>
<td>Jurassic Park (1993)</td>
<td>20739.13908</td>
</tr>
<tr>
<td>527</td>
<td>Schindler&rsquo;s List (1993)</td>
<td>20165.20986</td>
</tr>
<tr>
<td>110</td>
<td>Braveheart (1995)</td>
<td>20147.55487</td>
</tr>
<tr>
<td>1</td>
<td>Toy Story (1995)</td>
<td>19933.39382</td>
</tr>
<tr>
<td>457</td>
<td>Fugitive, The (1993)</td>
<td>19491.59012</td>
</tr>
<tr>
<td>150</td>
<td>Apollo 13 (1995)</td>
<td>19318.55769</td>
</tr>
<tr>
<td>590</td>
<td>Dances with Wolves (1990)</td>
<td>17342.45445</td>
</tr>
<tr>
<td>780</td>
<td>Independence Day (a.k.a. ID4) (1996)</td>
<td>17024.60940</td>
</tr>
<tr>
<td>608</td>
<td>Fargo (1996)</td>
<td>16663.43452</td>
</tr>
</tbody>
</table>
<h2 id="item-based-collaborative-filtering">Item-based collaborative filtering<a hidden class="anchor" aria-hidden="true" href="#item-based-collaborative-filtering">#</a></h2>
<p>Replicating the same work as in the previous section, but changing users for movies, I can obtain similarities between movies.</p>
<p>The table for the distances between films.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sql" data-lang="sql"><span style="display:flex;"><span><span style="color:#66d9ef">create</span> <span style="color:#66d9ef">table</span> movies_distances
</span></span><span style="display:flex;"><span>(
</span></span><span style="display:flex;"><span>	movie_a bigint <span style="color:#66d9ef">not</span> <span style="color:#66d9ef">null</span>,
</span></span><span style="display:flex;"><span>	movie_b bigint <span style="color:#66d9ef">not</span> <span style="color:#66d9ef">null</span>,
</span></span><span style="display:flex;"><span>	distance numeric <span style="color:#66d9ef">not</span> <span style="color:#66d9ef">null</span>,
</span></span><span style="display:flex;"><span>	similarity numeric
</span></span><span style="display:flex;"><span>);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">create</span> <span style="color:#66d9ef">index</span> movies_distances_b_index <span style="color:#66d9ef">on</span> movies_distances (movie_b);
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">create</span> <span style="color:#66d9ef">index</span> movies_distances_a_index <span style="color:#66d9ef">on</span> movies_distances (movie_a);
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">create</span> <span style="color:#66d9ef">index</span> movies_distances_a_b_index <span style="color:#66d9ef">on</span> movies_distances (movie_a, movie_b);
</span></span></code></pre></div><p>The function to calculate the Euclidean distance between the movies.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sql" data-lang="sql"><span style="display:flex;"><span><span style="color:#66d9ef">create</span> <span style="color:#66d9ef">or</span> <span style="color:#66d9ef">replace</span> <span style="color:#66d9ef">function</span> calc_eu_dist_movies(movie_a bigint, movie_b bigint) <span style="color:#66d9ef">returns</span> decimal
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">language</span> plpgsql
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">as</span> <span style="color:#960050;background-color:#1e0010">$$</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">declare</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">-- variables
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    f record;
</span></span><span style="display:flex;"><span>    d decimal;
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">begin</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">--body
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    d <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>.<span style="color:#ae81ff">0</span>;
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">for</span> f <span style="color:#66d9ef">in</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">select</span> <span style="color:#f92672">*</span> <span style="color:#66d9ef">from</span> (
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">select</span> user_id <span style="color:#66d9ef">as</span> user_id_a, rating <span style="color:#66d9ef">as</span> rating_a <span style="color:#66d9ef">from</span> ratings <span style="color:#66d9ef">where</span> movie_id <span style="color:#f92672">=</span> movie_a
</span></span><span style="display:flex;"><span>        ) <span style="color:#66d9ef">as</span> r1
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">inner</span> <span style="color:#66d9ef">join</span> (
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">select</span> user_id <span style="color:#66d9ef">as</span> user_id_b, rating <span style="color:#66d9ef">as</span> rating_b <span style="color:#66d9ef">from</span> ratings <span style="color:#66d9ef">where</span> movie_id <span style="color:#f92672">=</span> movie_b
</span></span><span style="display:flex;"><span>        ) <span style="color:#66d9ef">as</span> r2
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">on</span> r1.user_id_a <span style="color:#f92672">=</span> r2.user_id_b
</span></span><span style="display:flex;"><span>    loop
</span></span><span style="display:flex;"><span>        d <span style="color:#f92672">=</span> d <span style="color:#f92672">+</span> (f.rating_a <span style="color:#f92672">-</span> f.rating_b)<span style="color:#f92672">^</span><span style="color:#ae81ff">2</span>;
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">end</span> loop ;
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> sqrt(d);
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">end</span>;
</span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">$$</span>
</span></span></code></pre></div><p>The function to calculate the distance between movies and save them in the distance table. As in the previous section, we only calculate the distance of some films with respect to the others.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sql" data-lang="sql"><span style="display:flex;"><span><span style="color:#66d9ef">create</span> <span style="color:#66d9ef">or</span> <span style="color:#66d9ef">replace</span> <span style="color:#66d9ef">function</span> calc_movies_distances() <span style="color:#66d9ef">returns</span> int
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">language</span> plpgsql
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">as</span> <span style="color:#960050;background-color:#1e0010">$$</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">declare</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">-- variables
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    f1 record;
</span></span><span style="display:flex;"><span>    f2 record;
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">begin</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">--body
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">for</span> f1 <span style="color:#66d9ef">in</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">select</span> <span style="color:#66d9ef">distinct</span> movie_id <span style="color:#66d9ef">from</span> ratings <span style="color:#66d9ef">where</span> movie_id <span style="color:#f92672">&lt;=</span> <span style="color:#ae81ff">10</span>
</span></span><span style="display:flex;"><span>    loop
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">for</span> f2 <span style="color:#66d9ef">in</span>
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">select</span> <span style="color:#66d9ef">distinct</span> movie_id <span style="color:#66d9ef">from</span> ratings <span style="color:#66d9ef">where</span> movie_id <span style="color:#f92672">&lt;&gt;</span> f1.movie_id
</span></span><span style="display:flex;"><span>        loop
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">insert</span> <span style="color:#66d9ef">into</span> movies_distances (movie_a, movie_b, distance)
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">values</span> (f1.movie_id, f2.movie_id, calc_eu_dist_movies(f1.movie_id, f2.movie_id));
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">end</span> loop;
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">end</span> loop ;
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> <span style="color:#ae81ff">0</span>;
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">end</span>;
</span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">$$</span>
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sql" data-lang="sql"><span style="display:flex;"><span><span style="color:#66d9ef">select</span> calc_movies_distances();
</span></span></code></pre></div><p>Once the distances are obtained, calculate the similarity between movies and update the table with another function.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sql" data-lang="sql"><span style="display:flex;"><span><span style="color:#66d9ef">create</span> <span style="color:#66d9ef">or</span> <span style="color:#66d9ef">replace</span> <span style="color:#66d9ef">function</span> calc_movie_similarity() <span style="color:#66d9ef">returns</span> int
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">language</span> plpgsql
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">as</span> <span style="color:#960050;background-color:#1e0010">$$</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">declare</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">-- variables
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    f1 record;
</span></span><span style="display:flex;"><span>    max_dist decimal;
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">begin</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">--body
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#66d9ef">select</span> <span style="color:#66d9ef">max</span>(distance) <span style="color:#66d9ef">into</span> max_dist <span style="color:#66d9ef">from</span> movies_distances;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">for</span> f1 <span style="color:#66d9ef">in</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">select</span> movie_a, movie_b, distance <span style="color:#66d9ef">from</span> movies_distances
</span></span><span style="display:flex;"><span>    loop
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">update</span> movies_distances <span style="color:#66d9ef">set</span> similarity <span style="color:#f92672">=</span> (
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">case</span> <span style="color:#66d9ef">when</span> (f1.distance <span style="color:#f92672">&gt;</span> <span style="color:#ae81ff">0</span>.<span style="color:#ae81ff">0</span>) <span style="color:#66d9ef">then</span> (<span style="color:#ae81ff">1</span> <span style="color:#f92672">/</span> ((f1.distance<span style="color:#f92672">*</span><span style="color:#ae81ff">100</span>) <span style="color:#f92672">/</span> max_dist)) <span style="color:#66d9ef">else</span> <span style="color:#ae81ff">0</span> <span style="color:#66d9ef">end</span>
</span></span><span style="display:flex;"><span>        )
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">where</span> movie_a <span style="color:#f92672">=</span> f1.movie_a
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">and</span> movie_b <span style="color:#f92672">=</span> f1.movie_b;
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">end</span> loop;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> <span style="color:#ae81ff">0</span>;
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">end</span>;
</span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">$$</span>
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sql" data-lang="sql"><span style="display:flex;"><span><span style="color:#66d9ef">select</span> calc_movie_similarity();
</span></span></code></pre></div><p>A query to obtain the 10 most relevant recommendations according to a certain film</p>
<p>If we ask for recommendations based on the movie <strong>3 - Shadows in Paradise (Varjoja paratiisissa) (1986)</strong>:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sql" data-lang="sql"><span style="display:flex;"><span><span style="color:#66d9ef">select</span> m.id, m.title, <span style="color:#66d9ef">sum</span>(r.rating <span style="color:#f92672">*</span> md.similarity) <span style="color:#66d9ef">as</span> final_score
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">from</span> ratings <span style="color:#66d9ef">as</span> r
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">inner</span> <span style="color:#66d9ef">join</span> movies <span style="color:#66d9ef">as</span> m <span style="color:#66d9ef">on</span> (a.movie_id <span style="color:#f92672">=</span> m.id)
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">inner</span> <span style="color:#66d9ef">join</span> movies_distances <span style="color:#66d9ef">as</span> md
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">on</span> r.movie_id <span style="color:#f92672">=</span> md.movie_b
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">where</span> r.movie_id <span style="color:#66d9ef">not</span> <span style="color:#66d9ef">in</span> (
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">select</span> r2.movie_id <span style="color:#66d9ef">from</span> ratings <span style="color:#66d9ef">as</span> r2 <span style="color:#66d9ef">where</span> r2.movie_id <span style="color:#f92672">=</span> <span style="color:#ae81ff">3</span>
</span></span><span style="display:flex;"><span>)
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">and</span> md.movie_a <span style="color:#f92672">=</span> <span style="color:#ae81ff">3</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">group</span> <span style="color:#66d9ef">by</span> m.id, m.title
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">order</span> <span style="color:#66d9ef">by</span> final_score <span style="color:#66d9ef">desc</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">limit</span> <span style="color:#ae81ff">10</span>
</span></span></code></pre></div><table>
<thead>
<tr>
<th>id</th>
<th>title</th>
<th>final_score</th>
</tr>
</thead>
<tbody>
<tr>
<td>274</td>
<td>Silence of the Lambs, The (1991)</td>
<td>38976.71169</td>
</tr>
<tr>
<td>278</td>
<td>Shawshank Redemption, The (1994)</td>
<td>35165.68601</td>
</tr>
<tr>
<td>11</td>
<td>Star Wars: Episode IV - A New Hope (1977)</td>
<td>32377.39083</td>
</tr>
<tr>
<td>680</td>
<td>Pulp Fiction (1994)</td>
<td>30801.94301</td>
</tr>
<tr>
<td>14334</td>
<td>Secret of Roan Inish, The (1994)</td>
<td>30688.44737</td>
</tr>
<tr>
<td>629</td>
<td>Usual Suspects, The (1995)</td>
<td>29038.40834</td>
</tr>
<tr>
<td>19186</td>
<td>Parent Trap, The (1961)</td>
<td>28691.33482</td>
</tr>
<tr>
<td>13</td>
<td>Forrest Gump (1994)</td>
<td>27871.52393</td>
</tr>
<tr>
<td>1892</td>
<td>Star Wars: Episode VI - Return of the Jedi (1983)</td>
<td>27412.73468</td>
</tr>
<tr>
<td>424</td>
<td>Schindler&rsquo;s List (1993)</td>
<td>26701.82843</td>
</tr>
</tbody>
</table>
<hr>
<h2 id="conclusions">Conclusions<a hidden class="anchor" aria-hidden="true" href="#conclusions">#</a></h2>
<p><strong>Advantages</strong></p>
<p>Few, but to say the least:</p>
<ul>
<li>Space is much cheaper and more abundant than memory.</li>
<li>It&rsquo;s cheaper (and maybe easier) to scale by making read replicas of the database than to build a new instance and load the model into memory.</li>
<li>&ldquo;Re-training&rdquo; the <em>model</em> is simply launching the functions to update the distances and list of recommendations, which can be executed for the specific items of a specific user when necessary (for example, if the user accepts one of the recommendations or by triggers). There is no need to repeat all function calls for all users and all movies.</li>
</ul>
<p><strong>Disadvantages</strong></p>
<ul>
<li>After creating the appropriate views, optimizing certain queries, and creating some indexes, when running the final queries the speed at which query results are returned is more acceptable, but is still too slow to be operational.</li>
<li>The mechanism is too simple, it does not have much added value nor does it take into account basic characteristics, such as the aging of scores.</li>
<li>Not very flexible: if we want to try different &ldquo;algorithms&rdquo; or systems, we have to redo a lot of the work.</li>
<li>We can only work with simple mechanisms, the complex algorithms currently used in ML are completely ruled out (although there are some interesting initiatives in this regard <a href="https://postgresml.org/">https://postgresml.org/</a>)</li>
</ul>
<p><strong>Final thoughts</strong></p>
<p>Well, I&rsquo;ve been entertained and found it interesting for a while, but that&rsquo;s it.</p>
<p>It&rsquo;s better to pay a little and do things properly.</p>


  </div>

  <footer class="post-footer">
    <ul class="post-tags">
    </ul>
  </footer><div id="disqus_thread"></div>
<script>
    window.disqus_config = function () {
    
    
    
    };
    (function() {
        if (["localhost", "127.0.0.1"].indexOf(window.location.hostname) != -1) {
            document.getElementById('disqus_thread').innerHTML = 'Disqus comments not available by default when the website is previewed locally.';
            return;
        }
        var d = document, s = d.createElement('script'); s.async = true;
        s.src = '//' + "devjoyops" + '.disqus.com/embed.js';
        s.setAttribute('data-timestamp', +new Date());
        (d.head || d.body).appendChild(s);
    })();
</script>
<noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
<a href="https://disqus.com" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a>


</article>
    </main>
    
<footer class="footer">
        <span>&copy; 2024 <a href="https://devjoyops.github.io/">DevJoyOps</a></span> · 

    <span>
        Powered by
        <a href="https://gohugo.io/" rel="noopener noreferrer" target="_blank">Hugo</a> &
        <a href="https://github.com/adityatelange/hugo-PaperMod/" rel="noopener" target="_blank">PaperMod</a>
    </span>
</footer>
<a href="#top" aria-label="go to top" title="Go to Top (Alt + G)" class="top-link" id="top-link" accesskey="g">
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 12 6" fill="currentColor">
        <path d="M12 6H0l6-6z" />
    </svg>
</a>

<script>
    let menu = document.getElementById('menu')
    if (menu) {
        menu.scrollLeft = localStorage.getItem("menu-scroll-position");
        menu.onscroll = function () {
            localStorage.setItem("menu-scroll-position", menu.scrollLeft);
        }
    }

    document.querySelectorAll('a[href^="#"]').forEach(anchor => {
        anchor.addEventListener("click", function (e) {
            e.preventDefault();
            var id = this.getAttribute("href").substr(1);
            if (!window.matchMedia('(prefers-reduced-motion: reduce)').matches) {
                document.querySelector(`[id='${decodeURIComponent(id)}']`).scrollIntoView({
                    behavior: "smooth"
                });
            } else {
                document.querySelector(`[id='${decodeURIComponent(id)}']`).scrollIntoView();
            }
            if (id === "top") {
                history.replaceState(null, null, " ");
            } else {
                history.pushState(null, null, `#${id}`);
            }
        });
    });

</script>
<script>
    var mybutton = document.getElementById("top-link");
    window.onscroll = function () {
        if (document.body.scrollTop > 800 || document.documentElement.scrollTop > 800) {
            mybutton.style.visibility = "visible";
            mybutton.style.opacity = "1";
        } else {
            mybutton.style.visibility = "hidden";
            mybutton.style.opacity = "0";
        }
    };

</script>
<script>
    document.getElementById("theme-toggle").addEventListener("click", () => {
        if (document.body.className.includes("dark")) {
            document.body.classList.remove('dark');
            localStorage.setItem("pref-theme", 'light');
        } else {
            document.body.classList.add('dark');
            localStorage.setItem("pref-theme", 'dark');
        }
    })

</script>
</body>

</html>
