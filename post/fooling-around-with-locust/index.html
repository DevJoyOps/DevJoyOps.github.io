<!DOCTYPE html>
<html lang="en" dir="auto">

<head><meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<meta name="robots" content="index, follow">
<title>Fooling around with Locust | DevJoyOps</title>
<meta name="keywords" content="">
<meta name="description" content="I am considering replacing Gatling with Locust for load tests. The only reason (for now) is that it&rsquo;s a Python-based tool, since right now Gatling is the only one in my current stack where I&rsquo;m using Scala, and I&rsquo;d like to simplify it (and have the possibility for more people to a team can start writing tests).
According to Locust website:
https://docs.locust.io/en/stable/what-is-locust.html
What is Locust?
Locust is an open source performance/load testing tool for HTTP and other protocols.">
<meta name="author" content="">
<link rel="canonical" href="https://devjoyops.github.io/post/fooling-around-with-locust/">
<link crossorigin="anonymous" href="/assets/css/stylesheet.b609c58d5c11bb90b1a54e04005d74ad1ddf22165eb79f5533967e57df9c3b50.css" integrity="sha256-tgnFjVwRu5CxpU4EAF10rR3fIhZet59VM5Z&#43;V9&#43;cO1A=" rel="preload stylesheet" as="style">
<link rel="icon" href="https://devjoyops.github.io/favicon.ico">
<link rel="icon" type="image/png" sizes="16x16" href="https://devjoyops.github.io/favicon-16x16.png">
<link rel="icon" type="image/png" sizes="32x32" href="https://devjoyops.github.io/favicon-32x32.png">
<link rel="apple-touch-icon" href="https://devjoyops.github.io/apple-touch-icon.png">
<link rel="mask-icon" href="https://devjoyops.github.io/safari-pinned-tab.svg">
<meta name="theme-color" content="#2e2e33">
<meta name="msapplication-TileColor" content="#2e2e33">
<link rel="alternate" hreflang="en" href="https://devjoyops.github.io/post/fooling-around-with-locust/">
<noscript>
    <style>
        #theme-toggle,
        .top-link {
            display: none;
        }

    </style>
    <style>
        @media (prefers-color-scheme: dark) {
            :root {
                --theme: rgb(29, 30, 32);
                --entry: rgb(46, 46, 51);
                --primary: rgb(218, 218, 219);
                --secondary: rgb(155, 156, 157);
                --tertiary: rgb(65, 66, 68);
                --content: rgb(196, 196, 197);
                --code-block-bg: rgb(46, 46, 51);
                --code-bg: rgb(55, 56, 62);
                --border: rgb(51, 51, 51);
            }

            .list {
                background: var(--theme);
            }

            .list:not(.dark)::-webkit-scrollbar-track {
                background: 0 0;
            }

            .list:not(.dark)::-webkit-scrollbar-thumb {
                border-color: var(--theme);
            }
        }

    </style>
</noscript>
  

<meta property="og:title" content="Fooling around with Locust" />
<meta property="og:description" content="I am considering replacing Gatling with Locust for load tests. The only reason (for now) is that it&rsquo;s a Python-based tool, since right now Gatling is the only one in my current stack where I&rsquo;m using Scala, and I&rsquo;d like to simplify it (and have the possibility for more people to a team can start writing tests).
According to Locust website:
https://docs.locust.io/en/stable/what-is-locust.html
What is Locust?
Locust is an open source performance/load testing tool for HTTP and other protocols." />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://devjoyops.github.io/post/fooling-around-with-locust/" /><meta property="article:section" content="post" />
<meta property="article:published_time" content="2024-04-21T17:13:20+02:00" />
<meta property="article:modified_time" content="2024-04-21T17:13:20+02:00" />

<meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="Fooling around with Locust"/>
<meta name="twitter:description" content="I am considering replacing Gatling with Locust for load tests. The only reason (for now) is that it&rsquo;s a Python-based tool, since right now Gatling is the only one in my current stack where I&rsquo;m using Scala, and I&rsquo;d like to simplify it (and have the possibility for more people to a team can start writing tests).
According to Locust website:
https://docs.locust.io/en/stable/what-is-locust.html
What is Locust?
Locust is an open source performance/load testing tool for HTTP and other protocols."/>


<script type="application/ld+json">
{
  "@context": "https://schema.org",
  "@type": "BreadcrumbList",
  "itemListElement": [
    {
      "@type": "ListItem",
      "position":  1 ,
      "name": "Posts",
      "item": "https://devjoyops.github.io/post/"
    }, 
    {
      "@type": "ListItem",
      "position":  2 ,
      "name": "Fooling around with Locust",
      "item": "https://devjoyops.github.io/post/fooling-around-with-locust/"
    }
  ]
}
</script>
<script type="application/ld+json">
{
  "@context": "https://schema.org",
  "@type": "BlogPosting",
  "headline": "Fooling around with Locust",
  "name": "Fooling around with Locust",
  "description": "I am considering replacing Gatling with Locust for load tests. The only reason (for now) is that it\u0026rsquo;s a Python-based tool, since right now Gatling is the only one in my current stack where I\u0026rsquo;m using Scala, and I\u0026rsquo;d like to simplify it (and have the possibility for more people to a team can start writing tests).\nAccording to Locust website:\nhttps://docs.locust.io/en/stable/what-is-locust.html\nWhat is Locust?\nLocust is an open source performance/load testing tool for HTTP and other protocols.",
  "keywords": [
    
  ],
  "articleBody": "I am considering replacing Gatling with Locust for load tests. The only reason (for now) is that it’s a Python-based tool, since right now Gatling is the only one in my current stack where I’m using Scala, and I’d like to simplify it (and have the possibility for more people to a team can start writing tests).\nAccording to Locust website:\nhttps://docs.locust.io/en/stable/what-is-locust.html\nWhat is Locust?\nLocust is an open source performance/load testing tool for HTTP and other protocols. Its developer-friendly approach lets you define your tests in regular Python code.\nLocust tests can be run from command line or using its web-based UI. Throughput, response times and errors can be viewed in real time and/or exported for later analysis.\nYou can import regular Python libraries into your tests, and with Locust’s pluggable architecture it is infinitely expandable. Unlike when using most other tools, your test design will never be limited by a GUI or domain-specific language.\nAnd with this I no longer waste time on the introduction. I’m also not going to go into theory or testing strategies.\nI know that knowing how a tool works is not the same as being clear about what to do with it, and that it is more important to be clear about the objectives we want to achieve, but today we have not come to that.\nSo there we go.\nCreating the virtual environment.\n$ virtualenv .venv --python=python3.10 $ . .venv/bin/activate The wheat To do a quick test with Locust the first thing is to set up a simple API with FastAPI, and Faker to generate test data in the API response.\n$ pip install fastapi Faker $ mkdir target $ touch target/main.py A “Quick and Dirty” script to start:\n# main.py from fastapi import FastAPI from faker import Faker from random import randint from time import sleep class FakeDB: def __init__(self) -\u003e None: self.__data = Faker() def __decide_response(self) -\u003e None: if randint(0, 10) == 1: if randint(0, 5) == 1: raise Exception else: sleep(randint(1, 6)) else: sleep(0.05) def get_people_list(self) -\u003e list: self.__decide_response() return [{ \"id\": i, \"name\": self.__data.name() } for i in range(1, 26)] def get_people_detail(self, person_id: int) -\u003e dict: self.__decide_response() return { \"id\": person_id, \"name\": self.__data.name(), \"company\": self.__data.company(), \"address\": self.__data.address(), \"job\": self.__data.job() } db = FakeDB() app = FastAPI() @app.get(\"/api\") def home_page(): return {\"msg\": \"Hi pals!\"} @app.get(\"/api/people\") def people_list(): data = db.get_people_list() return {\"result\": data} @app.get(\"/api/people/{person_id}\") def people_detail(person_id: int): data = db.get_people_detail(person_id=person_id) return {\"result\": data} I’m not going to bother ensuring consistency of responses, so each call will return different values. Errors and slower responses are also forced to appear randomly.\nIt’s not the prettiest way to do it, but it works and is enough to start playing.\n$ fastai run target/main.py The locust Install Locust and create the file with the tests.\n$ pip install locust $ mkdir test $ cd test $ touch locustfile.py The script # locustfile.py from locust import HttpUser, task class PeopleTest(HttpUser): @task def homepage(self): self.client.get(\"/api\") @task def people_list(self): self.client.get(\"/api/people\") @task def people_detail(self): i = 7 self.client.get(\"/api/people/{}\".format(i)) Very simple, without settings or customizations: direct calls to the API. Then we will see the changes that we can introduce.\nWe can start testing it.\nWeb Interface For the initial test run the Locust web interface.\n$ locust Starting web interface at http://0.0.0.0:8089 On the initial page it asks us for a series of parameters:\nNumber of users: what is the maximum peak number of users that we want to reach. Ramp up: how many new users will be added every second from the starting value until reaching the peak. Host: base url against which we will run the tests. Advanced options - Run time: duration of the test. Once the values are set, the execution begins.\nAfter the 2 minutes, we have the results.\nWe can navigate through the different tabs to see more information.\nIn the charts option we see how the response time has varied throughout the execution (due to the forced delay that we have introduced).\nThe summary of errors received from the target API (also forced).\nAlso, of course, we can download the reports in CSV format with the information on the execution of the tests in case we want to load them into our own tool to analyze the data.\nAll this is fine, but it is impractical to scheduling periodic or remote executions and collecting the data. Can we do something about this?\nWell, yes, we can.\nCommand line execution If we want to automate the execution of the tests or even integrate them into a pipeline (why not? Worse things have been seen) it is necessary to be able to execute them from a command line, and it is essential that files with the reports can be generated.\nWe could do the same execution that we have done from the web interface by executing:\nlocust -f locustfile.py --headless --users 50 --spawn-rate 2 -t 2m -H http://0.0.0.0:8000 --csv csv/target Or even using a configuration file with the parameters we use:\n# locust.conf locustfile = locustfile.py host = http://0.0.0.0:8000 headless = true users = 100 spawn-rate = 2 run-time = 10s locust --config locust.conf --csv csv/target Other settings This quick test leaves many points to consider, and many improvements that we can make.\nFor example, in a real application we should extract the ids (ideally uids) from the results of a call to the listings, so we must establish a strategy to read them from a previous request, or load known test data with those ids.\nAnother example: in the case that our API requires authentication, we have the on_start method that would be executed automatically to obtain the access token (we have to handle for the next calls).\nclass PeopleTest(HttpUser): def on_start(self): response = self.client.post( \"/api/token\", json={ \"username\": \"myuser\", \"password\": \"b4d-pa55w0rd\" } ) # obtener el token de response... ... The HttpUser class has several properties to modify the execution behavior, such as wait_time to establish an automatic delay between requests.\n# locustfile.py from locust import HttpUser, task, between class PeopleTest(HttpUser): wait_time = between(0.5, 2) ... The @task decorator can also be parameterized to set a weight for that request, so that call would be executed n more times than an unparameterized one\n@task(3) def people_list(self): self.client.get(\"/api/people\") We can also run Locust in a Docker container, so we only have to worry about keeping the file with our tests in our repository, without having to install any libraries in our project.\nhttps://docs.locust.io/en/stable/running-in-docker.html\nAnd this without using plugins yet. We have a few to expand the capabilities of Locust, adding new protocols, using input data from CSV or MongoDB, and more.\nhttps://github.com/SvenskaSpel/locust-plugins\nI still have to send and view the data in an external tool, but with this little work we have everything we need to start considering Locust as a more than viable replacement for Gatling.\n",
  "wordCount" : "1135",
  "inLanguage": "en",
  "datePublished": "2024-04-21T17:13:20+02:00",
  "dateModified": "2024-04-21T17:13:20+02:00",
  "mainEntityOfPage": {
    "@type": "WebPage",
    "@id": "https://devjoyops.github.io/post/fooling-around-with-locust/"
  },
  "publisher": {
    "@type": "Organization",
    "name": "DevJoyOps",
    "logo": {
      "@type": "ImageObject",
      "url": "https://devjoyops.github.io/favicon.ico"
    }
  }
}
</script>
</head>

<body class="" id="top">
<script>
    if (localStorage.getItem("pref-theme") === "dark") {
        document.body.classList.add('dark');
    } else if (localStorage.getItem("pref-theme") === "light") {
        document.body.classList.remove('dark')
    } else if (window.matchMedia('(prefers-color-scheme: dark)').matches) {
        document.body.classList.add('dark');
    }

</script>

<header class="header">
    <nav class="nav">
        <div class="logo">
            <a href="https://devjoyops.github.io/" accesskey="h" title="DevJoyOps (Alt + H)">DevJoyOps</a>
            <div class="logo-switches">
                <button id="theme-toggle" accesskey="t" title="(Alt + T)">
                    <svg id="moon" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24"
                        fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                        stroke-linejoin="round">
                        <path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"></path>
                    </svg>
                    <svg id="sun" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24"
                        fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                        stroke-linejoin="round">
                        <circle cx="12" cy="12" r="5"></circle>
                        <line x1="12" y1="1" x2="12" y2="3"></line>
                        <line x1="12" y1="21" x2="12" y2="23"></line>
                        <line x1="4.22" y1="4.22" x2="5.64" y2="5.64"></line>
                        <line x1="18.36" y1="18.36" x2="19.78" y2="19.78"></line>
                        <line x1="1" y1="12" x2="3" y2="12"></line>
                        <line x1="21" y1="12" x2="23" y2="12"></line>
                        <line x1="4.22" y1="19.78" x2="5.64" y2="18.36"></line>
                        <line x1="18.36" y1="5.64" x2="19.78" y2="4.22"></line>
                    </svg>
                </button>
            </div>
        </div>
        <ul id="menu">
        </ul>
    </nav>
</header>
<main class="main">

<article class="post-single">
  <header class="post-header">
    
    <h1 class="post-title entry-hint-parent">
      Fooling around with Locust
    </h1>
    <div class="post-meta"><span title='2024-04-21 17:13:20 +0200 CEST'>April 21, 2024</span>

</div>
  </header> 
  <div class="post-content"><p>I am considering replacing Gatling with Locust for load tests. The only reason (for now) is that it&rsquo;s a Python-based tool, since right now Gatling is the only one in my current stack where I&rsquo;m using Scala, and I&rsquo;d like to simplify it (and have the possibility for more people to a team can start writing tests).</p>
<p>According to Locust website:</p>
<blockquote>
<p><a href="https://docs.locust.io/en/stable/what-is-locust.html">https://docs.locust.io/en/stable/what-is-locust.html</a></p>
</blockquote>
<p><strong>What is Locust?</strong></p>
<blockquote>
<p>Locust is an open source performance/load testing tool for HTTP and other protocols. Its developer-friendly approach lets you define your tests in regular Python code.</p>
<p>Locust tests can be run from command line or using its web-based UI. Throughput, response times and errors can be viewed in real time and/or exported for later analysis.</p>
<p>You can import regular Python libraries into your tests, and with Locust’s pluggable architecture it is infinitely expandable. Unlike when using most other tools, your test design will never be limited by a GUI or domain-specific language.</p>
</blockquote>
<p>And with this I no longer waste time on the introduction. I&rsquo;m also not going to go into theory or testing strategies.</p>
<p>I know that knowing how a tool works is not the same as being clear about what to do with it, and that it is more important to be clear about the objectives we want to achieve, but today we have not come to that.</p>
<p>So there we go.</p>
<p>Creating the virtual environment.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span>$ virtualenv .venv --python<span style="color:#f92672">=</span>python3.10
</span></span><span style="display:flex;"><span>$ . .venv/bin/activate
</span></span></code></pre></div><h2 id="the-wheat">The wheat<a hidden class="anchor" aria-hidden="true" href="#the-wheat">#</a></h2>
<p>To do a quick test with Locust the first thing is to set up a simple API with FastAPI, and Faker to generate test data in the API response.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span>$ pip install fastapi Faker
</span></span><span style="display:flex;"><span>$ mkdir target
</span></span><span style="display:flex;"><span>$ touch target/main.py
</span></span></code></pre></div><p>A &ldquo;Quick and Dirty&rdquo; script to start:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#75715e"># main.py</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">from</span> fastapi <span style="color:#f92672">import</span> FastAPI
</span></span><span style="display:flex;"><span><span style="color:#f92672">from</span> faker <span style="color:#f92672">import</span> Faker
</span></span><span style="display:flex;"><span><span style="color:#f92672">from</span> random <span style="color:#f92672">import</span> randint
</span></span><span style="display:flex;"><span><span style="color:#f92672">from</span> time <span style="color:#f92672">import</span> sleep
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">class</span> <span style="color:#a6e22e">FakeDB</span>:
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">def</span> __init__(self) <span style="color:#f92672">-&gt;</span> <span style="color:#66d9ef">None</span>:
</span></span><span style="display:flex;"><span>        self<span style="color:#f92672">.</span>__data <span style="color:#f92672">=</span> Faker()
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">__decide_response</span>(self) <span style="color:#f92672">-&gt;</span> <span style="color:#66d9ef">None</span>:
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">if</span> randint(<span style="color:#ae81ff">0</span>, <span style="color:#ae81ff">10</span>) <span style="color:#f92672">==</span> <span style="color:#ae81ff">1</span>:
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">if</span> randint(<span style="color:#ae81ff">0</span>, <span style="color:#ae81ff">5</span>) <span style="color:#f92672">==</span> <span style="color:#ae81ff">1</span>:
</span></span><span style="display:flex;"><span>                <span style="color:#66d9ef">raise</span> <span style="color:#a6e22e">Exception</span>
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">else</span>:
</span></span><span style="display:flex;"><span>                sleep(randint(<span style="color:#ae81ff">1</span>, <span style="color:#ae81ff">6</span>))
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">else</span>:
</span></span><span style="display:flex;"><span>            sleep(<span style="color:#ae81ff">0.05</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">get_people_list</span>(self) <span style="color:#f92672">-&gt;</span> list:
</span></span><span style="display:flex;"><span>        self<span style="color:#f92672">.</span>__decide_response()
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">return</span> [{
</span></span><span style="display:flex;"><span>            <span style="color:#e6db74">&#34;id&#34;</span>: i,
</span></span><span style="display:flex;"><span>            <span style="color:#e6db74">&#34;name&#34;</span>: self<span style="color:#f92672">.</span>__data<span style="color:#f92672">.</span>name()
</span></span><span style="display:flex;"><span>        } <span style="color:#66d9ef">for</span> i <span style="color:#f92672">in</span> range(<span style="color:#ae81ff">1</span>, <span style="color:#ae81ff">26</span>)]
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">get_people_detail</span>(self, person_id: int) <span style="color:#f92672">-&gt;</span> dict:
</span></span><span style="display:flex;"><span>        self<span style="color:#f92672">.</span>__decide_response()
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">return</span> {
</span></span><span style="display:flex;"><span>            <span style="color:#e6db74">&#34;id&#34;</span>: person_id,
</span></span><span style="display:flex;"><span>            <span style="color:#e6db74">&#34;name&#34;</span>: self<span style="color:#f92672">.</span>__data<span style="color:#f92672">.</span>name(),
</span></span><span style="display:flex;"><span>            <span style="color:#e6db74">&#34;company&#34;</span>: self<span style="color:#f92672">.</span>__data<span style="color:#f92672">.</span>company(),
</span></span><span style="display:flex;"><span>            <span style="color:#e6db74">&#34;address&#34;</span>: self<span style="color:#f92672">.</span>__data<span style="color:#f92672">.</span>address(),
</span></span><span style="display:flex;"><span>            <span style="color:#e6db74">&#34;job&#34;</span>: self<span style="color:#f92672">.</span>__data<span style="color:#f92672">.</span>job()
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>db <span style="color:#f92672">=</span> FakeDB()
</span></span><span style="display:flex;"><span>app <span style="color:#f92672">=</span> FastAPI()
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">@app.get</span>(<span style="color:#e6db74">&#34;/api&#34;</span>)
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">def</span> <span style="color:#a6e22e">home_page</span>():
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> {<span style="color:#e6db74">&#34;msg&#34;</span>: <span style="color:#e6db74">&#34;Hi pals!&#34;</span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">@app.get</span>(<span style="color:#e6db74">&#34;/api/people&#34;</span>)
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">def</span> <span style="color:#a6e22e">people_list</span>():
</span></span><span style="display:flex;"><span>    data <span style="color:#f92672">=</span> db<span style="color:#f92672">.</span>get_people_list()
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> {<span style="color:#e6db74">&#34;result&#34;</span>: data}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">@app.get</span>(<span style="color:#e6db74">&#34;/api/people/</span><span style="color:#e6db74">{person_id}</span><span style="color:#e6db74">&#34;</span>)
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">def</span> <span style="color:#a6e22e">people_detail</span>(person_id: int):
</span></span><span style="display:flex;"><span>    data <span style="color:#f92672">=</span> db<span style="color:#f92672">.</span>get_people_detail(person_id<span style="color:#f92672">=</span>person_id)
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> {<span style="color:#e6db74">&#34;result&#34;</span>: data}
</span></span></code></pre></div><p>I&rsquo;m not going to bother ensuring consistency of responses, so each call will return different values. Errors and slower responses are also forced to appear randomly.</p>
<p>It&rsquo;s not the prettiest way to do it, but it works and is enough to start playing.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span>$ fastai run target/main.py
</span></span></code></pre></div><h2 id="the-locust">The locust<a hidden class="anchor" aria-hidden="true" href="#the-locust">#</a></h2>
<p>Install Locust and create the file with the tests.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span>$ pip install locust
</span></span><span style="display:flex;"><span>$ mkdir test
</span></span><span style="display:flex;"><span>$ cd test
</span></span><span style="display:flex;"><span>$ touch locustfile.py
</span></span></code></pre></div><h3 id="the-script">The script<a hidden class="anchor" aria-hidden="true" href="#the-script">#</a></h3>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#75715e"># locustfile.py</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">from</span> locust <span style="color:#f92672">import</span> HttpUser, task
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">class</span> <span style="color:#a6e22e">PeopleTest</span>(HttpUser):
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">@task</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">homepage</span>(self):
</span></span><span style="display:flex;"><span>        self<span style="color:#f92672">.</span>client<span style="color:#f92672">.</span>get(<span style="color:#e6db74">&#34;/api&#34;</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">@task</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">people_list</span>(self):
</span></span><span style="display:flex;"><span>        self<span style="color:#f92672">.</span>client<span style="color:#f92672">.</span>get(<span style="color:#e6db74">&#34;/api/people&#34;</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">@task</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">people_detail</span>(self):
</span></span><span style="display:flex;"><span>        i <span style="color:#f92672">=</span> <span style="color:#ae81ff">7</span>
</span></span><span style="display:flex;"><span>        self<span style="color:#f92672">.</span>client<span style="color:#f92672">.</span>get(<span style="color:#e6db74">&#34;/api/people/</span><span style="color:#e6db74">{}</span><span style="color:#e6db74">&#34;</span><span style="color:#f92672">.</span>format(i))
</span></span></code></pre></div><p>Very simple, without settings or customizations: direct calls to the API. Then we will see the changes that we can introduce.</p>
<p>We can start testing it.</p>
<h3 id="web-interface">Web Interface<a hidden class="anchor" aria-hidden="true" href="#web-interface">#</a></h3>
<p>For the initial test run the Locust web interface.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span>$ locust
</span></span><span style="display:flex;"><span>Starting web interface at http://0.0.0.0:8089
</span></span></code></pre></div><p>On the initial page it asks us for a series of parameters:</p>
<ul>
<li><strong>Number of users</strong>: what is the maximum peak number of users that we want to reach.</li>
<li><strong>Ramp up</strong>: how many new users will be added every second from the starting value until reaching the peak.</li>
<li><strong>Host</strong>: base url against which we will run the tests.</li>
<li><strong>Advanced options - Run time</strong>: duration of the test.</li>
</ul>
<p><img loading="lazy" src="/post/fooling-around-with-locust/images/001-locust-ui.png" alt="image"  />
</p>
<p>Once the values are set, the execution begins.</p>
<p><img loading="lazy" src="/post/fooling-around-with-locust/images/002-locust-ui-execution.png" alt="image"  />
</p>
<p>After the 2 minutes, we have the results.</p>
<p><img loading="lazy" src="/post/fooling-around-with-locust/images/003-locust-ui-finish.png" alt="image"  />
</p>
<p>We can navigate through the different tabs to see more information.</p>
<p>In the charts option we see how the response time has varied throughout the execution (due to the forced delay that we have introduced).</p>
<p><img loading="lazy" src="/post/fooling-around-with-locust/images/004-locust-ui-charts.png" alt="image"  />
</p>
<p>The summary of errors received from the target API (also forced).</p>
<p><img loading="lazy" src="/post/fooling-around-with-locust/images/005-locust-ui-failures.png" alt="image"  />
</p>
<p>Also, of course, we can download the reports in CSV format with the information on the execution of the tests in case we want to load them into our own tool to analyze the data.</p>
<p><img loading="lazy" src="/post/fooling-around-with-locust/images/006-locust-ui-reports.png" alt="image"  />
</p>
<p>All this is fine, but it is impractical to scheduling periodic or remote executions and collecting the data. Can we do something about this?</p>
<p>Well, yes, we can.</p>
<h3 id="command-line-execution">Command line execution<a hidden class="anchor" aria-hidden="true" href="#command-line-execution">#</a></h3>
<p>If we want to automate the execution of the tests or even integrate them into a pipeline (why not? Worse things have been seen) it is necessary to be able to execute them from a command line, and it is essential that files with the reports can be generated.</p>
<p>We could do the same execution that we have done from the web interface by executing:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span>locust -f locustfile.py --headless --users <span style="color:#ae81ff">50</span> --spawn-rate <span style="color:#ae81ff">2</span> -t 2m -H http://0.0.0.0:8000 --csv csv/target
</span></span></code></pre></div><p>Or even using a configuration file with the parameters we use:</p>
<pre tabindex="0"><code class="language-conf" data-lang="conf"># locust.conf
locustfile = locustfile.py
host = http://0.0.0.0:8000
headless = true
users = 100
spawn-rate = 2
run-time = 10s
</code></pre><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span>locust --config locust.conf --csv csv/target
</span></span></code></pre></div><h3 id="other-settings">Other settings<a hidden class="anchor" aria-hidden="true" href="#other-settings">#</a></h3>
<p>This quick test leaves many points to consider, and many improvements that we can make.</p>
<p>For example, in a real application we should extract the ids (ideally uids) from the results of a call to the listings, so we must establish a strategy to read them from a previous request, or load known test data with those ids.</p>
<p>Another example: in the case that our API requires authentication, we have the <code>on_start</code> method that would be executed automatically to obtain the access token (we have to handle for the next calls).</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#66d9ef">class</span> <span style="color:#a6e22e">PeopleTest</span>(HttpUser):
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">on_start</span>(self):
</span></span><span style="display:flex;"><span>        response <span style="color:#f92672">=</span> self<span style="color:#f92672">.</span>client<span style="color:#f92672">.</span>post(
</span></span><span style="display:flex;"><span>            <span style="color:#e6db74">&#34;/api/token&#34;</span>, 
</span></span><span style="display:flex;"><span>            json<span style="color:#f92672">=</span>{
</span></span><span style="display:flex;"><span>                <span style="color:#e6db74">&#34;username&#34;</span>: <span style="color:#e6db74">&#34;myuser&#34;</span>, 
</span></span><span style="display:flex;"><span>                <span style="color:#e6db74">&#34;password&#34;</span>: <span style="color:#e6db74">&#34;b4d-pa55w0rd&#34;</span>
</span></span><span style="display:flex;"><span>            }
</span></span><span style="display:flex;"><span>        )
</span></span><span style="display:flex;"><span>        <span style="color:#75715e"># obtener el token de response...</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">...</span>
</span></span></code></pre></div><p>The <code>HttpUser</code> class has several properties to modify the execution behavior, such as <code>wait_time</code> to establish an automatic delay between requests.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#75715e"># locustfile.py</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">from</span> locust <span style="color:#f92672">import</span> HttpUser, task, between
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">class</span> <span style="color:#a6e22e">PeopleTest</span>(HttpUser):
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    wait_time <span style="color:#f92672">=</span> between(<span style="color:#ae81ff">0.5</span>, <span style="color:#ae81ff">2</span>)
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">...</span>
</span></span></code></pre></div><p>The <code>@task</code> decorator can also be parameterized to set a weight for that request, so that call would be executed <em>n</em> more times than an unparameterized one</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#a6e22e">@task</span>(<span style="color:#ae81ff">3</span>)
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">def</span> <span style="color:#a6e22e">people_list</span>(self):
</span></span><span style="display:flex;"><span>    self<span style="color:#f92672">.</span>client<span style="color:#f92672">.</span>get(<span style="color:#e6db74">&#34;/api/people&#34;</span>)
</span></span></code></pre></div><p>We can also run Locust in a Docker container, so we only have to worry about keeping the file with our tests in our repository, without having to install any libraries in our project.</p>
<blockquote>
<p><a href="https://docs.locust.io/en/stable/running-in-docker.html">https://docs.locust.io/en/stable/running-in-docker.html</a></p>
</blockquote>
<p>And this without using plugins yet. We have a few to expand the capabilities of Locust, adding new protocols, using input data from CSV or MongoDB, and more.</p>
<blockquote>
<p><a href="https://github.com/SvenskaSpel/locust-plugins">https://github.com/SvenskaSpel/locust-plugins</a></p>
</blockquote>
<p>I still have to send and view the data in an external tool, but with this little work we have everything we need to start considering Locust as a more than viable replacement for Gatling.</p>


  </div>

  <footer class="post-footer">
    <ul class="post-tags">
    </ul>
  </footer><div id="disqus_thread"></div>
<script>
    window.disqus_config = function () {
    
    
    
    };
    (function() {
        if (["localhost", "127.0.0.1"].indexOf(window.location.hostname) != -1) {
            document.getElementById('disqus_thread').innerHTML = 'Disqus comments not available by default when the website is previewed locally.';
            return;
        }
        var d = document, s = d.createElement('script'); s.async = true;
        s.src = '//' + "devjoyops" + '.disqus.com/embed.js';
        s.setAttribute('data-timestamp', +new Date());
        (d.head || d.body).appendChild(s);
    })();
</script>
<noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
<a href="https://disqus.com" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a>


</article>
    </main>
    
<footer class="footer">
        <span>&copy; 2024 <a href="https://devjoyops.github.io/">DevJoyOps</a></span> · 

    <span>
        Powered by
        <a href="https://gohugo.io/" rel="noopener noreferrer" target="_blank">Hugo</a> &
        <a href="https://github.com/adityatelange/hugo-PaperMod/" rel="noopener" target="_blank">PaperMod</a>
    </span>
</footer>
<a href="#top" aria-label="go to top" title="Go to Top (Alt + G)" class="top-link" id="top-link" accesskey="g">
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 12 6" fill="currentColor">
        <path d="M12 6H0l6-6z" />
    </svg>
</a>

<script>
    let menu = document.getElementById('menu')
    if (menu) {
        menu.scrollLeft = localStorage.getItem("menu-scroll-position");
        menu.onscroll = function () {
            localStorage.setItem("menu-scroll-position", menu.scrollLeft);
        }
    }

    document.querySelectorAll('a[href^="#"]').forEach(anchor => {
        anchor.addEventListener("click", function (e) {
            e.preventDefault();
            var id = this.getAttribute("href").substr(1);
            if (!window.matchMedia('(prefers-reduced-motion: reduce)').matches) {
                document.querySelector(`[id='${decodeURIComponent(id)}']`).scrollIntoView({
                    behavior: "smooth"
                });
            } else {
                document.querySelector(`[id='${decodeURIComponent(id)}']`).scrollIntoView();
            }
            if (id === "top") {
                history.replaceState(null, null, " ");
            } else {
                history.pushState(null, null, `#${id}`);
            }
        });
    });

</script>
<script>
    var mybutton = document.getElementById("top-link");
    window.onscroll = function () {
        if (document.body.scrollTop > 800 || document.documentElement.scrollTop > 800) {
            mybutton.style.visibility = "visible";
            mybutton.style.opacity = "1";
        } else {
            mybutton.style.visibility = "hidden";
            mybutton.style.opacity = "0";
        }
    };

</script>
<script>
    document.getElementById("theme-toggle").addEventListener("click", () => {
        if (document.body.className.includes("dark")) {
            document.body.classList.remove('dark');
            localStorage.setItem("pref-theme", 'light');
        } else {
            document.body.classList.add('dark');
            localStorage.setItem("pref-theme", 'dark');
        }
    })

</script>
</body>

</html>
